version: "1.0"
title: Docker Volume Mount Errors
scope: docker
severity: high
category: docker-errors
tags:
  - docker
  - volumes
  - mounts
  - docker-compose
  - golden-rules
last_updated: "2026-01-08"
errors:
  - id: "DOCKER-020"
    title: "Docker Automatically Recreates Deleted Directories"
    severity: "high"
    scope: docker
    problem: |
      Running `sudo rm -rf /path/to/dir` succeeds, but the directory reappears immediately.
      This happens when Docker containers have active volume mounts pointing to that directory.

      **Symptoms:**
      - Command succeeds with no error
      - Directory reappears with root:root ownership
      - Directory birth time shows recent creation
      - Permission denied when trying to create files

      **Root Cause:**
      Docker daemon detects that a mounted directory is gone and immediately recreates it
      because running containers require those mounts. The recreated directory is owned
      by root because Docker runs as root.
    wrong_code: |
      # Terminal output showing the issue:
      $ sudo rm -rf /home/ozand/dify
      $ ls -la /home/ozand/dify
      drwxr-xr-x 3 root root 4096 Jan 5 19:09 .

      # Birth time shows recent recreation:
      $ stat /home/ozand/dify
      Birth: 2026-01-05 19:09:55  # Created by Docker just now!
    correct_code: |
      # 1. Stop containers using the directory FIRST
      docker-compose down

      # OR stop specific containers:
      docker stop container_name_1 container_name_2

      # 2. THEN remove the directory
      sudo rm -rf /path/to/dir

      # 3. Verify it's gone
      ls -la /path/to/dir  # Should show "No such file or directory"
    diagnosis_steps: |
      1. Check what containers are mounting the directory:
         ```bash
         docker ps --format '{{.Names}}' | xargs -I {} docker inspect {} --format '{{range .Mounts}}{{.Source}} -> {{.Destination}}{{"\n"}}{{end}}' | grep /path/to/dir
         ```

      2. Check if containers are running:
         ```bash
         docker ps | grep container_name
         ```

      3. Check directory birth time (shows recreation):
         ```bash
         stat /path/to/dir
         ```

      4. Check for processes using the directory:
         ```bash
         lsof | grep /path/to/dir
         ```

      5. Check Docker container labels:
         ```bash
         docker inspect container_name --format '{{.Config.Labels}}'
         ```
    related_entries:
      - DOCKER-021
      - DOCKER-013
      - UNIVERSAL-001
    references: []

  - id: "DOCKER-021"
    title: "Wrong Volume Mount Paths in docker-compose.yml"
    severity: "high"
    scope: docker
    problem: |
      Docker Compose volume mounts point to root directories instead of following
      Golden Rules organization (should be /projects/ for code, /appdata/ for data).

      This causes:
      - Golden Rules violations
      - Cleanup difficulties (directories can't be deleted)
      - Data scattered across filesystem
      - Permission issues

      **Common Pattern:**
      - Volume: /home/ozand/project-name:/app  ❌ WRONG
      - Should be: /home/ozand/projects/project-name:/app  ✅ CORRECT
    wrong_code: |
      version: '3.8'
      services:
        app:
          image: myapp:latest
          volumes:
            - /home/ozand/aparser:/app  # ❌ Root directory violation
            - /home/ozand/dify/data:/app/data  # ❌ Should be in /appdata/
          ports:
            - "8080:8080"
    correct_code: |
      version: '3.8'
      services:
        app:
          image: myapp:latest
          volumes:
            # ✅ Code in /projects/
            - /home/ozand/projects/aparser:/app

            # ✅ Persistent data in /appdata/
            - /home/ozand/appdata/dify/data:/app/data

          ports:
            - "8080:8080"
    diagnosis_steps: |
      1. Check docker-compose.yml for volume mounts:
         ```bash
         grep -A 5 "volumes:" /path/to/docker-compose.yml
         ```

      2. Verify mount paths follow Golden Rules:
         - Code/config: /home/ozand/projects/<name>/
         - Data: /home/ozand/appdata/<name>/

      3. Check actual container mounts:
         ```bash
         docker inspect container_name --format '{{range .Mounts}}{{.Source}} -> {{.Destination}}{{"\n"}}{{end}}'
         ```

      4. List root directory violations:
         ```bash
         ls -d /home/ozand/*/ | grep -v -E "(projects|docs|appdata|tools|archives|backups|Desktop|Documents|Downloads|Music|Pictures|Public|Templates|Videos|snap)"
         ```

      5. Fix the paths in docker-compose.yml:
         ```bash
         sed -i.bak 's|/home/ozand/project-name|/home/ozand/projects/project-name|g' docker-compose.yml
         ```
    related_entries:
      - DOCKER-020
      - DOCKER-013
      - UNIVERSAL-001
    references: []
