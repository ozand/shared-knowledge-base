# Nginx Analytics and Monitoring Patterns
# Web server log analysis and traffic monitoring

version: "1.0"
category: "web-analytics"
last_updated: "2026-01-05"

patterns:
  - id: "VPS-WEB-001"
    title: "Nginx Log Analysis and Quick Stats"
    severity: "medium"
    scope: "vps"

    description: |
      Monitor Nginx access patterns, identify top clients, detect scanners,
      and analyze traffic trends using lightweight tools.

    pattern:
      code: |
        # 1. Quick stats (instant, no GoAccess dependency)
        sudo nginx-stats

        # Output includes:
        # - Top 5 IPs by request count
        # - Top 10 paths requested
        # - Status code distribution
        # - Bandwidth usage

        # 2. Full analytics with GoAccess (interactive)
        sudo nginx-analytics

        # Features:
        # - Real-time dashboard
        # - Traffic by hour/day
        # - Request methods
        # - Static vs dynamic content
        # - GeoIP (if configured)

      explanation: |
        nginx-stats provides instant analysis using awk, perfect for quick checks.
        nginx-analytics uses GoAccess for comprehensive real-time dashboard.

    detection_patterns:
      code: |
        # Identify scanners and bots
        sudo awk '{print $1}' /var/log/nginx/access.log | \
            sort | uniq -c | sort -rn | head -10

        # Check what paths are being attacked
        sudo grep ".git" /var/log/nginx/access.log | \
            awk '{print $1}' | sort | uniq -c | sort -rn

        # Find 404 errors (potential probing)
        sudo awk '$9 == 404' /var/log/nginx/access.log | \
            awk -F'"' '{print $2}' | awk '{print $2}' | \
            sort | uniq -c | sort -rn | head -20

    security_monitoring:
      code: |
        # Check for PHP exploit attempts
        sudo grep -i "\.php" /var/log/nginx/access.log | \
            awk '{print $1}' | sort | uniq -c | sort -rn

        # Look for vulnerability scanning
        sudo grep -E "(\.git|\.env|wp-admin|xmlrpc)" \
            /var/log/nginx/access.log | awk '{print $1}' | \
            sort | uniq -c | sort -rn

        # Check for SQL injection attempts
        sudo grep -i "union.*select" /var/log/nginx/access.log | \
            awk '{print $1}' | sort | uniq -c | sort -rn

    bandwidth_analysis:
      code: |
        # Total bandwidth by IP
        sudo awk '{sum[$1]+=$10} END {for (ip in sum) \
            printf "%15s %15d bytes\n", ip, sum[ip]}' \
            /var/log/nginx/access.log | sort -k2 -rn | head -10

        # Bandwidth by path
        sudo awk -F'"' '{print $2}' /var/log/nginx/access.log | \
            awk '{print $2}' | awk '{path[$1]++; bytes[$1]+=$NF} \
            END {for (p in path) printf "%6d reqs %15s bytes  %s\n", \
            path[p], bytes[p], p}' | sort -rn | head -20

    troubleshooting:
      code: |
        # Check for HTTP errors (4xx, 5xx)
        sudo awk '$9 >= 400 {print $9}' /var/log/nginx/access.log | \
            sort | uniq -c | sort -rn

        # View recent errors with context
        sudo awk '$9 >= 400 {print $0}' /var/log/nginx/access.log | \
            tail -20

        # Check for slow requests (if $request_time logged)
        sudo awk '$NF > 5.0 {print $NF, $0}' \
            /var/log/nginx/access.log | sort -rn | head -20

    log_rotation:
      code: |
        # Check log file sizes
        sudo ls -lh /var/log/nginx/

        # Force log rotation (if needed)
        sudo logrotate -f /etc/logrotate.d/nginx

        # Compress old logs
        sudo gzip /var/log/nginx/access.log.1

    integration:
      code: |
        # Via vps-admin tool
        vps-admin nginx-status    # Check Nginx status
        vps-admin nginx-check     # Validate configuration
        vps-admin nginx-logs 100  # View recent logs
        vps-admin nginx-sites     # List enabled sites

    automation:
      code: |
        # Daily analytics report (cron)
        # Add to crontab:
        0 8 * * * root /usr/local/bin/nginx-stats > /var/log/nginx/daily-stats.log

        # Weekly summary
        0 8 * * 1 root /usr/local/bin/nginx-analytics --output \
            /var/log/nginx/weekly-report.html

    related_issues:
      - "VPS-SEC-001: Malicious scanner detection and blocking"
      - "VPS-NET-001: Port 8080 conflict resolution"
      - "VPS-LOG-001: Log file cleanup"

    references:
      - "nginx-quick-stats.sh script"
      - "nginx-analytics.sh script"
      - "/etc/nginx/conf.d/security.conf"
