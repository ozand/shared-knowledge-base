# Agent Auto-Configuration Pattern
# Automatic discovery and application of KB instructions by agents

version: "1.0"
category: "agent-workflow"
last_updated: "2026-01-06"

patterns:
  - id: "AGENT-AUTO-001"
    title: "Agent Auto-Configuration from Knowledge Base"
    severity: "high"
    scope: "universal"
    tags: ["agent", "automation", "configuration", "bootstrap", "kb-integration"]

    problem: |
      **Manual Configuration Problem:**

      Current approach requires manual setup for each agent:
      - System prompts must be manually updated per agent
      - Project names must be manually configured
      - Agent types must be manually specified
      - Instructions must be manually distributed to all agents
      - Updates require re-configuring all agents

      **Real Example:**
      To add GITHUB-ATTRIB-001 to 10 projects:
      - Update 10 system prompts manually
      - Create project labels manually
      - Test each agent individually
      - Result: 2-3 hours of manual work

      **Scalability Issues:**
      - New project created → manual setup required
      - KB updated → agents don't know about changes
      - New pattern added → agents can't use it automatically
      - Manual approach doesn't scale beyond 5-10 projects

      **Desired State:**
      - Deploy Shared KB to project → agents auto-configure
      - Update Shared KB → agents get updates automatically
      - Create new project → agent sets up itself
      - Zero manual configuration required

    solution: |
      **Self-Configuring Agent System:**

      ## Phase 1: Auto-Discovery

      **Agent automatically detects:**

      1. **Agent Type:**
         ```bash
         # From environment or capabilities
         export AGENT_TYPE="claude-code"  # or cursor-ai, copilot, etc.
         ```

      2. **Project Name:**
         ```bash
         # From git remote
         git remote get-url origin
         # → git@github.com:user/PARSER.git
         # → Extract: PARSER
         ```

         **Or from config files:**
         - `package.json` → `name` field
         - `pyproject.toml` → `project.name`
         - `Cargo.toml` → `package.name`
         - `.agent-config` → explicit project name

      3. **Agent Role:**
         ```python
         # From task context
         role = detect_task_type(task)
         # → "code-generation", "debugging", "refactoring", etc.
         ```

      4. **Shared KB Location:**
         ```bash
         # Search in known locations
         - docs/knowledge-base/shared/
         - .shared-kb/
         - knowledge-base/
         - KB_PATH environment variable
         ```

      ## Phase 2: Bootstrap Process

      **Agent on startup:**

      ```python
      def bootstrap_agent():
          """Called when agent starts"""

          # 1. Detect context
          context = detect_context()

          # 2. Find Shared KB
          kb_path = find_knowledge_base()

          # 3. Load base instructions
          instructions = load_agent_instructions(kb_path)

          # 4. Apply instructions
          apply_instructions(instructions, context)

          # 5. Register capabilities
          register_capabilities(instructions)

          return context
      ```

      ## Phase 3: Instruction Loading

      **From Shared KB:**

      ```yaml
      # universal/agent-instructions/base-instructions.yaml
      version: "1.0"
      last_updated: "2026-01-06"

      applies_to: "all_agents"

      instructions:

        github_attribution:
          pattern: "GITHUB-ATTRIB-001"
          enabled: true
          required_when: "creating_issues_or_prs"

          steps:
            - "Add 'Created By' section at top of issue body"
            - "Use labels: agent:{agent_type}, project:{project_name}"
            - "Follow template in KB"

          template_path: "universal/agent-instructions/templates/issue-template.md"

        kb_contribution:
          pattern: "AGENT-HANDOFF-001"
          enabled: true
          required_when: "contributing_to_shared_kb"

          steps:
            - "Search KB before creating new pattern"
            - "Validate YAML before creating issue"
            - "Use GitHub issue with attribution"
            - "Wait for Curator review"

        quality_standards:
          pattern: "various"
          enabled: true
          required_when: "always"

          standards:
            - "Follow YAML-001 for YAML syntax"
            - "Use ISOLATED-TEST-001 for PR testing"
            - "Apply AGENT-ACCOUNTABILITY-001"

      # Auto-generated for each agent
      context:
        agent_type: "{{auto_detected}}"
        project_name: "{{auto_detected}}"
        session_id: "{{auto_generated}}"
      ```

      ## Phase 4: Auto-Update on KB Changes

      **When Shared KB is updated:**

      ```python
      def on_kb_update(kb_path):
          """Called when KB git pull happens"""

          # 1. Check instruction version
          new_version = read_version(kb_path)
          old_version = read_cached_version()

          if new_version > old_version:
              # 2. Load new instructions
              new_instructions = load_agent_instructions(kb_path)

              # 3. Notify agent
              notify_agent(
                  "KB updated. New instructions available.",
                  changes=diff_instructions(old_instructions, new_instructions)
              )

              # 4. Re-configure if needed
              if new_instructions.requires_reconfigure:
                  apply_instructions(new_instructions, detect_context())
          ```

      ## Phase 5: Capability Registration

      **Agent discovers what it can do:**

      ```python
      # From instructions
      capabilities = {
          "create_github_issue": {
              "enabled": true,
              "attribution_required": true,
              "labels": ["agent:*", "project:*", "agent-type:*"]
          },
          "contribute_to_kb": {
              "enabled": true,
              "validation_required": true,
              "workflow": "AGENT-HANDOFF-001"
          }
      }
      ```

    implementation: "@references/AGENT-AUTO-001-implementation.md"

    best_practices:
      - practice: "Store all agent instructions in Shared KB"
        reason: "Single source of truth, auto-distributed"

      - practice: "Auto-detect project context"
        reason: "Zero manual configuration"

      - practice: "Use .agent-config for overrides"
        reason: "Allows project-specific customization"

      - practice: "Check for KB updates periodically"
        reason: "Agents automatically get new patterns"

      - practice: "Version instructions"
        reason: "Track when agents need updates"

    anti_patterns:
      - pattern: "Hardcode agent config in system prompts"
        consequence: "Manual updates required, doesn't scale"

      - pattern: "Copy instructions to each project"
        consequence: "Duplication, sync issues"

      - pattern: "Manual project name configuration"
        consequence: "Forget to configure, wrong attribution"

      - pattern: "Static instructions that never update"
        consequence: "Agents miss new KB patterns"

    examples: "@references/AGENT-AUTO-001-examples.md"

    success_criteria:
      - ✅ "Deploy KB → agents auto-configure"
      - ✅ "Update KB → agents get updates"
      - ✅ "Zero manual system prompt editing"
      - ✅ "Auto-detect project context"
      - ✅ "Single source of truth in KB"

    related_patterns:
      - id: "GITHUB-ATTRIB-001"
        title: "GitHub Agent and Project Attribution"

      - id: "AGENT-HANDOFF-001"
        title: "Cross-Repository Agent Collaboration"

      - id: "AGENT-ACCOUNTABILITY-001"
        title: "Agent Self-Accountability"

    implementation_checklist:
      setup:
        - step: "Add agent-instructions/ to KB"
          file: "universal/agent-instructions/base-instructions.yaml"

        - step: "Create bootstrap script"
          file: "tools/kb-agent-bootstrap.py"

        - step: "Add templates"
          file: "universal/agent-instructions/templates/*.md"

        - step: "Test bootstrap"
          command: "python tools/kb-agent-bootstrap.py"

      project_integration:
        - step: "Add Shared KB as submodule"
          command: "git submodule add <kb-url> docs/knowledge-base/shared"

        - step: "Run bootstrap once"
          command: "python docs/knowledge-base/shared/tools/kb-agent-bootstrap.py"

        - step: "Verify .agent-config.local created"
          check: "cat .agent-config.local"

        - step: "Test agent capabilities"
          test: "Create GitHub issue with attribution"

      maintenance:
        - step: "Update KB instructions when needed"
          trigger: "New pattern or workflow"

        - step: "Version instruction changes"
          method: "Update last_updated field"

        - step: "Test with existing projects"
          verify: "Agents pick up changes"

    prevention:
      - prevention: "Test agent configuration before production deployment"
        reason: "Catches configuration errors early"
        how: "Run agent with test task, verify it loads KB correctly"

      - prevention: "Document configuration dependencies clearly"
        reason: "Agents need to know what's required"
        how: "List required files, environment variables, tools in instructions"

      - prevention: "Version all configuration changes"
        reason: "Enables rollback if problems occur"
        how: "Update last_updated field when modifying agent configs"

      - prevention: "Use progressive disclosure for agent instructions"
        reason: "Prevents token bloat with large config files"
        how: "Load KB navigation first, detailed configs on demand"

      - prevention: "Validate KB structure before agent auto-configuration"
        reason: "Agents fail with corrupted or invalid KB"
        how: "Run kb.py validate before enabling auto-config"

      - prevention: "Test auto-configuration with multiple agent types"
        reason: "Different agents may interpret configs differently"
        how: "Test with primary-agent, researcher, code-reviewer, etc."

      - prevention: "Monitor agent performance after auto-configuration changes"
        reason: "Detects regressions or unexpected behavior"
        how: "Track agent success rates, error patterns, token usage"

languages: [en, ru]
