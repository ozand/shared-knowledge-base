version: "1.0"
category: "claude-code"
last_updated: "2026-01-07"

patterns:
  - id: "AGENT-ORCHESTRATION-001"
    title: "Multi-Agent Orchestration with Sequential Handoff Workflow"
    severity: "critical"
    scope: "universal"

    problem: |
      Coordinating multiple specialized agents for complex development tasks
      requires:
      - Clear handoff criteria between agents
      - Defined workflow and sequence
      - Proper deliverable transfer
      - Avoiding duplicate work
      - Managing parallel execution
      - Handling agent disagreements

      Without proper orchestration:
      - Agents work at cross-purposes
      - Deliverables don't match expectations
      - Work is duplicated or missed
      - No clear progression
      - Inefficient use of agent capabilities

    symptoms:
      - Agents redo each other's work
      - Unclear who should do what
      - Deliverables don't flow between agents
      - Parallel work causes conflicts
      - No clear completion criteria
      - Wasted agent time

    root_cause: |
      No defined orchestration pattern for coordinating multiple specialized
      agents with clear handoff workflows and deliverable transfer criteria.

    solution:
      code: |
        # Agent Orchestration Pattern
        # Sequential handoff workflow for specialized agents

        # Sequential Development Pipeline (8 phases):

        # Phase 1: Business Analyst (Requirements)
        # Input: Business idea from user
        # Process: Gather requirements, analyze stakeholders
        # Output: Requirements document
        # Handoff to: Project Manager
        #
        # Phase 2: Project Manager (Planning)
        # Input: Requirements document
        # Process: Create project plan, allocate resources
        # Output: Project plan with timeline and milestones
        # Handoff to: UX Engineer (in parallel with Tech Lead)
        #
        # Phase 3: UX Engineer (Design)
        # Input: Requirements + Project plan
        # Process: Design user experience and interfaces
        # Output: UX specifications, mockups
        # Handoff to: Frontend Engineer
        #
        # Phase 4: Tech Lead (Architecture)
        # Input: Requirements + Project plan
        # Process: Design technical architecture
        # Output: Architecture document, API specs
        # Handoff to: Database Engineer (in parallel with Backend)
        #
        # Phase 5: Database Engineer (Data)
        # Input: Architecture document
        # Process: Design database schema
        # Output: Database schema, migration scripts
        # Handoff to: Backend Engineer
        #
        # Phase 6a: Backend Engineer (Server)
        # Input: Architecture + Database schema
        # Process: Implement server-side logic
        # Output: Backend implementation, API documentation
        # Handoff to: Code Reviewer
        #
        # Phase 6b: Frontend Engineer (Client)
        # Input: UX specs + API documentation
        # Process: Implement client-side UI
        # Output: Frontend implementation
        # Handoff to: Code Reviewer
        #
        # Phase 7: Code Reviewer (Quality)
        # Input: Backend + Frontend implementations
        # Process: Review code quality, test coverage
        # Output: Review findings, approval/rejection
        # Handoff to: Security Reviewer
        #
        # Phase 8: Security Reviewer (Security)
        # Input: Code + review findings
        # Process: Security assessment, vulnerability scan
        # Output: Security assessment, approval
        # Handoff to: Deployment

        # Handoff Criteria:
        #
        # Each handoff must include:
        # 1. Deliverable document (complete and reviewed)
        # 2. Acceptance criteria checklist (all items checked)
        # 3. Open questions or concerns (documented)
        # 4. Next steps and expectations (clear)

        # Usage Example:

        # User: "Build a payment system for my e-commerce site"
        #
        # Claude: I'll orchestrate the specialized agents to build this:
        #
        # **Phase 1: Business Analyst**
        # Gathering requirements...
        # ✓ Requirements document complete (5 Must, 4 Should, 3 Could)
        # ✓ User stories with acceptance criteria defined
        # ✓ Priority matrix (MoSCoW) established
        # ✓ Risks identified and documented
        #
        # **Handoff to Project Manager**
        #
        # **Phase 2: Project Manager**
        # Creating project plan...
        # ✓ Timeline: 4 weeks with 5 milestones
        # ✓ Resource allocation: 2 developers, part-time specialists
        # ✓ Risk register with 5 mitigations
        # ✓ Communication plan established
        #
        # **Parallel Handoff:**
        # → To UX Engineer: Design phase starts Week 1
        # → To Tech Lead: Architecture phase starts Week 1
        #
        # **Phase 3: UX Engineer** (parallel with Tech Lead)
        # Designing user experience...
        # ✓ Checkout flow design complete
        # ✓ Payment form mockups created
        # ✓ Error state UX defined
        # ✓ Accessibility considerations addressed
        #
        # **Phase 4: Tech Lead** (parallel with UX Engineer)
        # Designing architecture...
        # ✓ Technology stack: React + Node.js + PostgreSQL
        # ✓ System architecture: Layered N-Tier
        # ✓ API specifications: 3 endpoints defined
        # ✓ Security architecture: JWT, PCI DSS compliance
        #
        # **Handoff:**
        # → UX Engineer → Frontend Engineer
        # → Tech Lead → Database Engineer
        #
        # **Phase 5: Database Engineer**
        # Designing database...
        # ✓ Schema: payments, users, orders tables
        # ✓ Indexes: Optimized for query patterns
        # ✓ Migration scripts: Version controlled
        # ✓ Data integrity: Foreign keys, constraints
        #
        # **Handoff to Backend Engineer**
        #
        # **Phase 6a: Backend Engineer**
        # Implementing server-side...
        # ✓ Payment API: 3 endpoints implemented
        # ✓ Stripe integration: Complete
        # ✓ Webhook handling: Secure verification
        # ✓ API documentation: OpenAPI/Swagger
        # ✓ Unit tests: 85% coverage
        #
        # **Phase 6b: Frontend Engineer**
        # Implementing client-side...
        # ✓ Payment form: React components
        # ✓ Stripe Elements: Integrated
        # ✓ State management: Zustand store
        # ✓ Error handling: User-friendly messages
        # ✓ Unit tests: 80% coverage
        #
        # **Handoff to Code Reviewer**
        #
        # **Phase 7: Code Reviewer**
        # Reviewing implementation...
        # ✓ Code quality: 8/10 (good structure, minor improvements needed)
        # ✓ Test coverage: 83% (meets 80% threshold)
        # ✓ Documentation: Complete with examples
        # ✓ Best practices: Generally followed
        # ✓ Security: No obvious vulnerabilities
        #
        # **Issues Found:**
        # - 3 minor code style issues
        # - 2 missing edge case tests
        # - 1 incomplete error message
        #
        # **Decision: Approve with minor fixes**
        #
        # **Handoff to Security Reviewer** (after fixes)
        #
        # **Phase 8: Security Reviewer**
        # Security assessment...
        # ✓ Authentication: JWT implemented correctly
        # ✓ PCI DSS: Stripe handles card data (compliant)
        # ✓ Input validation: All inputs validated
        # ✓ SQL injection: Prisma ORM prevents
        # ✓ XSS protection: React escaping prevents
        # ✓ CSRF protection: Token-based approach
        # ✓ Rate limiting: 100 req/min configured
        # ✓ Secrets: Environment variables used
        #
        # **Decision: Approve for deployment**
        #
        # ✓ Payment system complete and approved!

      explanation: |
        Agent Orchestration provides a structured workflow for coordinating
        multiple specialized agents, ensuring clear handoffs and efficient
        collaboration.

        **Core Principles:**

        1. **Sequential Progression**
           - Each agent builds on previous work
           - Clear handoff criteria
           - Defined deliverables
           - No ambiguity about next steps

        2. **Parallel Execution**
           - Some phases can run in parallel (UX + Tech Lead)
           - Reduces overall timeline
           - Requires coordination at handoff points

        3. **Quality Gates**
           - Each phase has acceptance criteria
           - Next agent validates previous work
           - Issues resolved before proceeding
           - No "broken telephone"

        4. **Feedback Loops**
           - Later agents can provide feedback to earlier phases
           - Iteration when issues found
           - Continuous improvement

        **Orchestration Patterns:**

        **1. Sequential (Waterfall)**
        - Each phase completes before next starts
        - Best for: Well-understood problems, clear requirements
        - Timeline: Longer but predictable

        **2. Parallel with Synchronization**
        - Multiple agents work simultaneously
        - Synchronize at key points
        - Best for: Independent work streams
        - Timeline: Shorter but requires coordination

        **3. Iterative**
        - Multiple cycles through agents
        - Each cycle improves the product
        - Best for: Complex problems, learning required
        - Timeline: Variable, depends on iterations

        **4. Hybrid**
        - Combine sequential and parallel
        - Adapt to project needs
        - Best for: Most real-world projects
        - Timeline: Optimized based on dependencies

        **Handoff Requirements:**

        **From Agent X to Agent Y:**
        1. **Deliverable Document**
           - Complete work product
           - Clear and well-documented
           - Meets acceptance criteria

        2. **Acceptance Checklist**
           - All required items present
           - Quality standards met
           - Reviewed by agent

        3. **Open Issues**
           - Documented concerns
           - Outstanding questions
           - Risks identified

        4. **Next Steps**
           - Clear expectations
           - Input requirements for next agent
           - Timeline considerations

        **Conflict Resolution:**

        **When agents disagree:**
        1. Document both perspectives
        2. Assess impact on project goals
        3. Consult relevant requirements
        4. Make decision based on priority
        5. Document rationale and move forward

        **Quality Gates:**

        **Each phase must pass:**
        - Deliverable completeness
        - Quality standards met
        - Documentation adequate
        - Next agent can proceed
        - No blocking issues

    examples:
      - name: "Full sequential workflow for payment system"
        description: "All 8 phases in sequence with clear handoffs"
        before: |
          User: "Build payment system"
          Claude: [Single agent tries to do everything]
                  [No clear workflow]
                  [Mixed responsibilities]
                  [Quality issues]
        after: |
          User: "Build payment system"
          Claude: Orchestration with 8 specialized agents...

          **Workflow:**
          1. Business Analyst → Requirements
          2. Project Manager → Plan
          3. UX Engineer (parallel) → Design
          4. Tech Lead (parallel) → Architecture
          5. Database Engineer → Schema
          6. Backend Engineer → Server
          6. Frontend Engineer → Client
          7. Code Reviewer → Quality
          8. Security Reviewer → Security

          **Result:** Each agent focused, clear handoffs, high quality
        result: "Efficient workflow with clear responsibilities"

      - name: "Parallel execution reduces timeline"
        description: "UX Engineer and Tech Lead work in parallel"
        before: |
          User: "Add user dashboard"
          Claude: [Sequential execution]
                  - UX design: 3 days
                  - Tech architecture: 2 days
                  Total: 5 days
        after: |
          User: "Add user dashboard"
          Claude: Parallel execution...

          **Day 1-3:**
          - UX Engineer: Design (3 days)
          - Tech Lead: Architecture (2 days, done Day 2)

          **Day 3-4:**
          - Tech Lead: Help Database Engineer
          - UX Engineer: Complete design

          **Day 4-10:**
          - Frontend + Backend implement

          **Result:** Saved 1 day through parallel work
        result: "20% time savings through parallelization"

      - name: "Quality gate catches issue early"
        description: "Code Reviewer catches backend issue"
        before: |
          User: "Implement feature"
          Claude: [No quality gates]
                  [Bug in production]
                  [Expensive fix]
        after: |
          User: "Implement feature"
          Claude: Quality gates at each phase...

          **Phase 6: Backend Engineer**
          ✓ Implementation complete

          **Phase 7: Code Reviewer**
          ✗ Issue found: Race condition in payment processing
          → Back to Backend Engineer for fix
          ✓ Fix verified

          **Phase 8: Security Reviewer**
          ✓ No issues found

          **Result:** Bug caught before production
        result: "Quality gate prevented production bug"

    benefits:
      - Clear workflow and responsibilities
      - Efficient use of specialized expertise
      - Quality gates prevent issues
      - Parallel execution reduces timeline
      - Handoffs ensure continuity
      - Conflicts resolved systematically
      - Scalable to complex projects

    prevention:
      - "Define clear handoff criteria before starting"
      - "Document deliverables at each phase"
      - "Use acceptance checklists for quality gates"
      - "Enable parallel execution where possible"
      - "Resolve conflicts through documented process"
      - "Don't skip phases or short-circuit workflow"
      - "Validate handoffs before proceeding"
      - "Learn from each iteration"
      - "Adapt workflow based on project needs"
      - "Keep communication clear between agents"

    tags: ["claude-code", "agents", "orchestration", "workflow", "coordination", "handoff"]

    related_patterns:
      - "SPECIALIZED-AGENTS-001"
      - "AGENT-BUSINESS-ANALYST-001"
      - "AGENT-PROJECT-MANAGER-001"
      - "AGENT-TECH-LEAD-001"
