# Base Agent Instructions
# Auto-loaded by all agents from Shared KB

version: "1.1"
last_updated: "2026-01-06"
applies_to: "all_agents"

metadata:
  pattern: "AGENT-AUTO-001"
  description: "Base instructions that all agents auto-load from Shared KB"
  auto_reload: true
  requires_reconfigure: false

instructions:

  # GitHub Attribution
  github_attribution:
    enabled: true
    priority: "HIGH"
    pattern: "GITHUB-ATTRIB-001"
    required_when: "creating_github_issues_or_prs"

    description: |
      When creating GitHub Issues or PRs, add attribution to make
      the agent and project visible in the GitHub UI.

    steps:
      - step: "Add 'Created By' section at VERY TOP of issue/PR body"
        template: "universal/agent-instructions/templates/issue-header.md"

      - step: "Use GitHub labels for filterable attribution"
        labels:
          - "agent:{agent_type}"  # claude-code, cursor-ai, copilot, curator
          - "project:{project_name}"  # Auto-detected from git/config
          - "agent-type:{task_type}"  # code-generation, debugging, etc.
          - "kb-improvement"  # For KB contributions
          - "{category}"  # python, postgresql, docker, etc.

      - step: "Include detailed metadata section"
        template: "universal/agent-instructions/templates/metadata-section.md"

    context_variables:
      - name: "agent_type"
        source: "auto_detect_or_env"
        env_var: "AGENT_TYPE"
        default: "claude-code"

      - name: "project_name"
        source: "auto_detect_from_git_or_config"
        detection_methods:
          - method: "git remote"
            command: "git remote get-url origin"
            extract: "Get last part of path"

          - method: "package.json"
            file: "package.json"
            field: "name"

          - method: "pyproject.toml"
            file: "pyproject.toml"
            field: "project.name"

          - method: ".agent-config"
            file: ".agent-config"
            field: "project_name"

        default: "unknown"

      - name: "agent_session"
        source: "auto_generate_or_env"
        env_var: "AGENT_SESSION"
        default: "session-{timestamp}"

      - name: "task_type"
        source: "detect_from_task_context"
        options:
          - "code-generation"
          - "debugging"
          - "refactoring"
          - "documentation"
          - "review"

    examples:
      - scenario: "Creating KB contribution issue"
        cli_command: |
          gh issue create \
            --label "agent:{agent_type}" \
            --label "project:{project_name}" \
            --label "agent-type:{task_type}" \
            --label "kb-improvement" \
            --title "Add PYTHON-XXX: Pattern Name" \
            --body-file issue-template.md

    quality_checks:
      - check: "Issue body has 'Created By' at first line"
        pass_if: "body.startswith('---\\n**Created By:**')"

      - check: "All required labels present"
        pass_if: "labels contain 'agent:*' and 'project:*'"

  # Role Enforcement (CRITICAL)
  role_enforcement:
    enabled: true
    priority: "CRITICAL"
    pattern: "AGENT-ROLE-SEPARATION-001"
    required_when: "always"

    description: |
      ‚ö†Ô∏è CRITICAL: Role-based access control for Shared Knowledge Base

      Project Agents MUST follow these rules to maintain quality
      and prevent role confusion.

    role_definition:
      project_agent:
        role: "Contributes to Shared KB"
        access: "Read-only access to shared-knowledge-base"
        can_do:
          - "Search KB: kb search '{query}'"
          - "Validate YAML locally: kb validate entry.yaml"
          - "Create GitHub issues with attribution"
          - "Pull KB updates: git pull"
        cannot_do:
          - "‚ùå Commit to shared-knowledge-base"
          - "‚ùå Create PR to shared-knowledge-base"
          - "‚ùå Modify KB files directly"
          - "‚ùå Fix KB errors directly"
          - "‚ùå Add patterns directly to KB"
        reason: "Curator maintains quality control via review process"

      curator_agent:
        role: "Maintains Shared KB"
        access: "Read-write access to shared-knowledge-base"
        can_do:
          - "Review GitHub issues from project agents"
          - "Validate YAML entries"
          - "Enhance contributions"
          - "Commit to shared-knowledge-base"
          - "Create PRs for internal changes"
        only_agent: "Curator is ONLY agent who commits to KB"

    forbidden_actions:
      - action: "git commit in shared-knowledge-base repository"
        severity: "BLOCKED"
        error: "Role violation: Use GitHub issue instead"
        correct_action: "Create GitHub issue with YAML entry"

      - action: "gh pr create to shared-knowledge-base"
        severity: "BLOCKED"
        error: "Role violation: Only Curator creates PRs"
        correct_action: "Create GitHub issue instead"

      - action: "Direct modification of KB files"
        severity: "BLOCKED"
        error: "Bypasses Curator quality control"
        correct_action: "Follow AGENT-HANDOFF-001 workflow"

      - action: "Fixing YAML errors in KB"
        severity: "HIGH"
        error: "Should report via issue, not fix"
        correct_action: "Create issue describing the error"

      - action: "Adding patterns directly to KB"
        severity: "HIGH"
        error: "Must go through review process"
        correct_action: "Create issue with validated YAML entry"

    correct_workflow:
      pattern: "AGENT-HANDOFF-001"
      when: "Contributing patterns to Shared KB"

      steps:
        - step: "Discover reusable pattern/improvement"
          in: "Project repository"

        - step: "Search KB first"
          command: "kb search '{keywords}'"
          verify: "If exists, don't create duplicate"

        - step: "Create YAML entry locally"
          location: "Project repository (not KB)"
          template: "Follow KB structure"

        - step: "Validate YAML"
          command: "python tools/kb.py validate entry.yaml"
          ensure: "No errors before creating issue"

        - step: "Create GitHub issue with attribution"
          repository: "shared-knowledge-base"
          labels:
            - "agent:{agent_type}"
            - "project:{project_name}"
            - "agent-type:{task_type}"
            - "kb-improvement"
            - "{category}"
          template: "universal/agent-instructions/templates/issue-template.md"

        - step: "Wait for Curator review"
          expected_sla: "24 hours"

        - step: "Curator validates and enhances"
          by: "Curator Agent in shared-knowledge-base"

        - step: "Curator commits to KB"
          action: "Curator adds pattern with attribution"

        - step: "Pull KB updates"
          command: "cd docs/knowledge-base/shared && git pull"

    technical_enforcement:
      pre_commit_hook:
        enabled: true
        script: "tools/pre-commit-role-check.py"
        blocks: "Non-curator commits to protected files"
        bypass: "touch .curator (Curator only)"

      protected_files:
        - "universal/"
        - "python/"
        - "postgresql/"
        - "javascript/"
        - "docker/"
        - "framework/"
        - "tools/"
        - "README.md"
        - "VERSION"

    real_world_example:
      wrong:
        scenario: "Project Agent updates KB to v5.1 directly"
        what_happened:
          - "Agent committed to shared-knowledge-base"
          - "Agent fixed YAML errors"
          - "Agent added patterns"
          - "Agent created PR #7"
        why_wrong:
          - "‚ùå Violated AGENT-ROLE-SEPARATION-001"
          - "‚ùå Bypassed Curator review"
          - "‚ùå Quality control bypassed"
        consequence: "Role confusion, potential quality issues"

      correct:
        scenario: "Project Agent discovers async timeout pattern"
        steps:
          - "Search KB: kb search 'async timeout'"
          - "Not found"
          - "Create YAML: async-timeout.yaml"
          - "Validate: kb validate async-timeout.yaml"
          - "Create GitHub issue with attribution"
          - "Curator reviews (24h)"
          - "Curator enhances and commits"
          - "Project agent pulls updates"
        result: "‚úÖ Clean workflow, quality maintained"

    references:
      - pattern: "AGENT-ROLE-SEPARATION-001"
        description: "Full role separation pattern with technical enforcement"

      - pattern: "AGENT-HANDOFF-001"
        description: "Cross-repository collaboration workflow"

      - pattern: "GITHUB-ATTRIB-001"
        description: "GitHub attribution for issues"

  # Git Submodule Access (CRITICAL)
  submodule_access:
    enabled: true
    priority: "CRITICAL"
    pattern: "AGENT-DIRECT-SUBMODULE-ACCESS-001"
    required_when: "working_with_git_submodules"

    description: |
      ‚ö†Ô∏è CRITICAL: Never use direct git commands on submodule directories.

      AI agents MUST use git submodule commands to maintain workflow integrity.
      Direct access breaks .gitmodules synchronization and submodule state.

    forbidden_patterns:
      - pattern: "git -C .*submodule"
        severity: "BLOCKED"
        error: "Direct submodule access forbidden"
        correct_action: "Use 'git submodule <command> <path>' from project root"

      - pattern: "cd .*submodule.*git"
        severity: "BLOCKED"
        error: "Bypasses .gitmodules synchronization"
        correct_action: "Use 'git submodule <command> <path>' from project root"

      - pattern: "git -C docs/knowledge-base/shared"
        severity: "BLOCKED"
        error: "Specific forbidden path for Shared KB"
        correct_action: "Use 'git submodule status docs/knowledge-base/shared'"

      - pattern: "cd docs/knowledge-base/shared && git"
        severity: "BLOCKED"
        error: "Direct cd into submodule forbidden"
        correct_action: "Stay in project root, use submodule commands"

    required_workflow:
      for_submodule_operations:
        - step: "Always check submodule status first"
          command: "git submodule status <path>"
          example: "git submodule status docs/knowledge-base/shared"
          interpret_output: "See SUBMODULE-STATUS-INTERPRETATION-001"

        - step: "Update submodule using submodule commands"
          command: "git submodule update --remote <path>"
          example: "git submodule update --remote docs/knowledge-base/shared"

        - step: "Initialize if needed"
          command: "git submodule update --init --recursive <path>"
          example: "git submodule update --init --recursive docs/knowledge-base/shared"

        - step: "Verify update succeeded"
          command: "git submodule status <path>"
          check: "Compare commit hash before/after"

      verification_rules:
        - rule: "Never cd into submodule directory"
          check: "Command does not contain 'cd docs/knowledge-base/shared'"
          pass_if: "Working from project root"

        - rule: "Always use git submodule prefix"
          check: "Command starts with 'git submodule'"
          pass_if: "Submodule commands used"

        - rule: "Use relative paths from project root"
          check: "Path is relative, not absolute"
          example: "docs/knowledge-base/shared (not /home/user/docs/...)"

        - rule: "Check status before operations"
          check: "First command is 'git submodule status'"
          pass_if: "Status verified before update"

    real_world_examples:
      wrong:
        scenario: "User asks '–æ–±–Ω–æ–≤–∏ —Å—Ç–∞—Ç—É—Å Share KB'"
        agent_response: |
          ```bash
          # WRONG - Direct access to submodule
          git -C /home/ozand/docs/knowledge-base/shared fetch origin
          git -C /home/ozand/docs/knowledge-base/shared log HEAD..origin/main
          python3 /home/ozand/docs/knowledge-base/shared/tools/kb.py stats
          ```
        why_wrong:
          - "‚ùå Used 'git -C' with submodule path"
          - "‚ùå Bypassed git submodule workflow"
          - "‚ùå Didn't check submodule status first"
          - "‚ùå Risk of detached HEAD state"
        consequence: "Breaks .gitmodules synchronization, submodule state corrupted"

      correct:
        scenario: "User asks '–æ–±–Ω–æ–≤–∏ —Å—Ç–∞—Ç—É—Å Share KB –∏—Å–ø–æ–ª—å–∑—É—è git submodule commands'"
        agent_response: |
          ```bash
          # CORRECT - Use submodule commands from project root
          git submodule status docs/knowledge-base/shared
          git submodule update --remote docs/knowledge-base/shared
          python3 docs/knowledge-base/shared/tools/kb.py stats
          ```
        why_correct:
          - "‚úÖ Used 'git submodule' commands"
          - "‚úÖ Checked status before update"
          - "‚úÖ Worked from project root"
          - "‚úÖ Maintained submodule integrity"
        result: "Proper submodule workflow, state synchronized"

      lesson: "Be explicit about workflow requirements. Say 'using git submodule commands' not just 'update status'"

    why_this_matters:
      explanation: |
        Git submodules are special:
        - Submodule has its own .git/ directory
        - Superproject tracks submodule commit hash
        - .gitmodules file contains submodule configuration
        - git submodule commands maintain this relationship

        Direct access breaks this:
        - .gitmodules not updated
        - Superproject's git link not updated
        - Can cause merge conflicts
        - May lead to detached HEAD state
        - Violates submodule workflow design

    references:
      - pattern: "AGENT-DIRECT-SUBMODULE-ACCESS-001"
        description: "Complete anti-pattern with troubleshooting"

      - pattern: "SUBMODULE-STATUS-INTERPRETATION-001"
        description: "Understanding git submodule status output"

      - pattern: "KB-UPDATE-001"
        description: "Shared KB update process with verification"

  # KB Contribution Workflow
  kb_contribution:
    enabled: true
    priority: "HIGH"
    pattern: "AGENT-HANDOFF-001"
    required_when: "contributing_patterns_to_shared_kb"

    description: |
      When contributing reusable error patterns or best practices to
      Shared Knowledge Base, follow the agent handoff workflow.

    steps:
      - step: "Search KB for existing patterns"
        command: "kb search '{pattern_keywords}'"
        verify: "If pattern exists, don't create duplicate"

      - step: "Create YAML entry following KB template"
        template: "Use KB template structure"
        validate: "python tools/kb.py validate entry.yaml"

      - step: "Create GitHub issue with attribution"
        workflow: "Follow GITHUB-ATTRIB-001"

      - step: "Wait for Curator review"
        expected_sla: "24 hours"

      - step: "Pull KB updates after merge"
        command: "cd docs/knowledge-base/shared && git pull"

    quality_standards:
      - standard: "YAML-001"
        description: "Follow YAML syntax best practices"
        validate: "python tools/kb.py validate"

      - standard: "GITHUB-ATTRIB-001"
        description: "Use proper attribution"
        verify: "Check labels and 'Created By' section"

    examples:
      - scenario: "Contributing error pattern"
        workflow: |
          1. Encounter error
          2. Search KB: kb search "error"
          3. Not found ‚Üí Create YAML
          4. Validate: kb validate pattern.yaml
          5. Create issue with attribution
          6. Curator reviews and merges
          7. Pull updates

  # Quality Standards
  quality_standards:
    enabled: true
    priority: "MEDIUM"
    pattern: "various"
    required_when: "always"

    standards:

      yaml_syntax:
        pattern: "YAML-001"
        description: "Common YAML syntax errors to avoid"
        applies_to: "creating_or_editing_yaml_files"

        rules:
          - rule: "Validate YAML before committing"
            command: "python tools/kb.py validate {file}"

          - rule: "Quote colons in mapping values"
            example: 'description: "error: something failed"'

          - rule: "Use consistent indentation"
            recommendation: "Use 2 spaces, no tabs"

          - rule: "Escape special characters"
            examples:
              - "\\n for newline"
              - "\\t for tab"
              - "\\\\ for backslash"

      isolated_testing:
        pattern: "ISOLATED-TEST-001"
        description: "Test in isolated environment, never in main repo"
        applies_to: "testing_pull_requests"

        strategies:
          - strategy: "Temporary clone (RECOMMENDED)"
            command: |
              cd /tmp && rm -rf pr-test && mkdir pr-test && cd pr-test
              git clone git@github.com:user/repo.git .
              git fetch origin pull/{number}/head:pr-branch
              git checkout pr-branch
              # Run tests
            cleanup: "rm -rf /tmp/pr-test"

          - strategy: "Git worktree"
            command: "git worktree add ../pr-test pr-branch"

      agent_accountability:
        pattern: "AGENT-ACCOUNTABILITY-001"
        description: "Follow your own recommendations"
        applies_to: "all_actions"

        workflow:
          - "Before acting: Search KB for relevant patterns"
          - "While acting: Follow documented best practices"
          - "After acting: Verify you followed your own recommendations"

        self_check_questions:
          - question: "Did I search KB before acting?"
          - question: "Am I following documented patterns?"
          - question: "Should I update docs based on this experience?"

      pr_review:
        pattern: "PR-REVIEW-001"
        description: "Review all PRs before merge"
        applies_to: "curator_agent_reviewing_prs"

        process:
          - "Test PR in isolated environment"
          - "Validate all YAML files"
          - "Check quality standards compliance"
          - "Provide clear feedback"

  # Documentation Practices
  documentation:
    enabled: true
    priority: "LOW"
    pattern: "DOC-SYNC-001"
    required_when: "updating_documentation"

    description: |
      When updating documentation, ensure all related files are updated
      consistently.

    steps:
      - step: "Map documentation dependencies"
        description: "Identify which files reference the documentation"

      - step: "Create update checklist"
        description: "List all files that need updates"

      - step: "Update files systematically"
        description: "Follow dependency order"

      - step: "Verify consistency"
        description: "Check cross-references and terminology"

    examples:
      - scenario: "Adding new Curator responsibility"
        files_to_update:
          - "curator/AGENT.md"
          - "curator/SKILLS.md"
          - "curator/WORKFLOWS.md"
          - "universal/patterns/pr-review-process.yaml"

  # Shared KB Installation Detection
  installation_detection:
    enabled: true
    priority: "HIGH"
    pattern: "UNIFIED-INSTALL-001"
    required_when: "kb_not_detected"

    description: |
      ‚ö†Ô∏è Auto-detect if Shared KB is installed in project.

      If Shared KB is not detected, suggest unified-install.py installation.

    detection:
      check_paths:
        - path: "docs/knowledge-base/shared"
          check_type: "directory_exists"
          required: true

        - path: "docs/knowledge-base/shared/tools/kb.py"
          check_type: "file_exists"
          required: true

        - path: ".claude/agents/kb-agent.md"
          check_type: "file_exists"
          required: false
          reason: "Optional: Agent templates may not be installed"

        - path: ".gitmodules"
          check_type: "file_contains"
          contains: "shared-knowledge-base"
          required: false
          reason: "Optional: May use clone instead of submodule"

      detection_command: |
        # Check if KB is installed
        if [ -d "docs/knowledge-base/shared" ]; then
          echo "KB detected: docs/knowledge-base/shared"
          exit 0
        else
          echo "KB not detected"
          exit 1
        fi

    on_not_detected:
      action: "suggest_installation"
      message: |
        ‚ö†Ô∏è Shared KB not detected in this project.

        To install Shared KB, run:

        # Method 1: From repository
        python scripts/unified-install.py --full

        # Method 2: Remote download (one-line)
        curl -sSL https://raw.githubusercontent.com/ozand/shared-knowledge-base/main/scripts/unified-install.py | python3 - --full

        This will:
        - Add submodule with sparse checkout
        - Install agents/skills/commands
        - Build search index
        - Verify installation

        For more info: python scripts/unified-install.py --help

      reference_pattern: "UNIFIED-INSTALL-001"
      reference_documentation:
        - "README.md - Quick Start section"
        - "AGENT-QUICK-START.md - Installation section"
        - "HARMONIZED-INSTALLATION-GUIDE.md - Complete guide"

    installation_methods:
      unified_install:
        method: "python scripts/unified-install.py --full"
        recommended: true
        reason: "Cross-platform, automated, includes all features"
        platforms:
          - "Windows"
          - "macOS"
          - "Linux"

        what_it_does:
          - "Adds submodule: docs/knowledge-base/shared"
          - "Configures sparse checkout (excludes curator/)"
          - "Installs agents (1 main + 4 subagents)"
          - "Installs skills (7 skills)"
          - "Installs commands (7 commands)"
          - "Creates configuration files"
          - "Builds search index"
          - "Verifies installation"

        flags:
          full: "--full (complete installation with all features)"
          minimal: "--minimal (core features only)"
          update: "--update (update existing installation)"
          check: "--check (check for updates)"
          verify: "--verify (verify installation)"

      manual_install:
        method: "git submodule add + install.py"
        recommended: false
        reason: "Requires additional manual steps"
        platforms:
          - "All"

        steps:
          - "git submodule add https://github.com/ozand/shared-knowledge-base.git docs/knowledge-base/shared"
          - "python docs/knowledge-base/shared/for-projects/scripts/install.py --full"

    deprecations:
      - method: "bash scripts/setup-shared-kb-sparse.sh"
        deprecated: true
        reason: "Only works on Unix/Linux, use unified-install.py for cross-platform support"

      - method: "powershell scripts/setup-shared-kb-sparse.ps1"
        deprecated: true
        reason: "BROKEN: Emoji in PowerShell causes 'Missing argument in parameter list' errors"

      - method: "sku install"
        deprecated: true
        reason: "SKU CLI not published to PyPI, use unified-install.py instead"

    examples:
      - scenario: "Agent starts in project without KB"
        detection: "Agent checks docs/knowledge-base/shared"
        result: "Not found"
        action: "Agent suggests unified-install.py"
        output: |
          ‚ö†Ô∏è Shared KB not detected in this project.

          To install Shared KB, run:

          python scripts/unified-install.py --full

      - scenario: "Agent starts in project with KB"
        detection: "Agent checks docs/knowledge-base/shared"
        result: "Found"
        action: "Agent continues normal workflow"
        output: "‚úÖ Shared KB detected at docs/knowledge-base/shared"

      - scenario: "Agent sees old installation method in docs"
        reads: "bash scripts/setup-shared-kb-sparse.sh"
        checks: "UNIFIED-INSTALL-001 pattern"
        sees: "Method deprecated, use unified-install.py instead"
        action: "Uses unified-install.py"
        output: "python scripts/unified-install.py --full"

    references:
      - pattern: "UNIFIED-INSTALL-001"
        description: "Complete unified installation pattern"

      - documentation: "HARMONIZED-INSTALLATION-GUIDE.md"
        description: "Complete installation guide"

      - documentation: "AGENT-INFORMATION-FLOW-ANALYSIS.md"
        description: "How agents discover installation methods"

# Agent capabilities registry
# Agents discover what they can do from this list
capabilities:
  github_operations:
    create_issue:
      enabled: true
      requires_attribution: true
      template: "universal/agent-instructions/templates/issue-template.md"

    create_pr:
      enabled: true
      requires_attribution: true
      template: "universal/agent-instructions/templates/pr-template.md"

    add_comment:
      enabled: true
      attribution_format: "**_Comment by ü§ñ {agent} ({project})_**"

  kb_operations:
    search:
      enabled: true
      command: "kb search '{query}'"

    validate:
      enabled: true
      command: "python tools/kb.py validate {file}"

    contribute:
      enabled: true
      workflow: "AGENT-HANDOFF-001"
      requires_attribution: true

# Context detection rules
context_detection:
  agent_type:
    methods:
      - source: "environment"
        variable: "AGENT_TYPE"

      - source: "config_file"
        file: ".agent-config"
        field: "agent_type"

      - source: "default"
        value: "claude-code"

  project_name:
    methods:
      - source: "git"
        command: "git remote get-url origin"
        extract: "project_name_from_url"

      - source: "package_json"
        file: "package.json"
        field: "name"

      - source: "pyproject_toml"
        file: "pyproject.toml"
        field: "project.name"

      - source: "config_file"
        file: ".agent-config"
        field: "project_name"

      - source: "default"
        value: "unknown"

  session_id:
    methods:
      - source: "environment"
        variable: "AGENT_SESSION"

      - source: "generate"
        format: "session-{timestamp}-{random}"

# Auto-update configuration
auto_update:
  enabled: true
  check_interval: "1h"
  method: "git_pull"

  on_update:
    reload_instructions: true
    notify_agent: true
    reconfigure_if: "version_mismatch"

# Version tracking
version:
  current: "1.0"
  last_updated: "2026-01-06"
  backward_compatible: true
  deprecation_notice: null
