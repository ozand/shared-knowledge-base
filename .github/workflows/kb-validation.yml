name: Knowledge Base Validation

# Automated validation for Shared Knowledge Base
# Runs on every push and pull request to ensure quality standards

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'domains/**/*.yaml'
      - 'tools/**/*.py'
      - '.github/workflows/*.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'domains/**/*.yaml'
      - 'tools/**/*.py'
      - '.github/workflows/*.yml'
  workflow_dispatch:

permissions:
  contents: read
  checks: write

jobs:
  validate-yaml:
    name: Validate YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate YAML syntax
        run: |
          echo "üîç Validating YAML files..."

          # Find all YAML files
          find domains -name "*.yaml" -o -name "*.yml" > yaml_files.txt

          # Validate each file
          FAILED=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "  Checking $file..."
              if ! python -c "import yaml; yaml.safe_load(open('$file'))"; then
                echo "  ‚ùå Invalid YAML: $file"
                FAILED=1
              else
                echo "  ‚úÖ Valid: $file"
              fi
            fi
          done < yaml_files.txt

          if [ $FAILED -eq 1 ]; then
            echo "‚ùå YAML validation failed"
            exit 1
          fi

          echo "‚úÖ All YAML files are valid"

      - name: Validate KB entry structure
        run: |
          echo "üîç Validating KB entry structure..."

          python3 << 'EOF'
          import os
          import yaml
          import sys
          from pathlib import Path

          def validate_kb_entry(filepath):
              """Validate a KB entry YAML file"""
              errors = []

              with open(filepath, 'r') as f:
                  try:
                      data = yaml.safe_load(f)
                  except Exception as e:
                      return [f"YAML parsing error: {e}"]

              # Check required top-level fields
              required_fields = ['version', 'category', 'last_updated']
              for field in required_fields:
                  if field not in data:
                      errors.append(f"Missing required field: {field}")

              # Check for errors or patterns section
              if 'errors' not in data and 'patterns' not in data:
                  errors.append("Missing 'errors' or 'patterns' section")

              # Validate entries if present
              if 'errors' in data:
                  for entry in data['errors']:
                      # Check required entry fields
                      if 'id' not in entry:
                          errors.append("Entry missing 'id' field")
                      if 'title' not in entry:
                          errors.append("Entry missing 'title' field")
                      if 'severity' not in entry:
                          errors.append("Entry missing 'severity' field")
                      if 'scope' not in entry:
                          errors.append("Entry missing 'scope' field")
                      if 'problem' not in entry:
                          errors.append("Entry missing 'problem' field")
                      if 'solution' not in entry:
                          errors.append("Entry missing 'solution' field")

                      # Validate ID format
                      if 'id' in entry:
                          id_val = entry['id']
                          if not isinstance(id_val, str) or len(id_val.split('-')) < 2:
                              errors.append(f"Invalid ID format: {id_val}")

              return errors

          # Find all YAML files in domains/
          domains_path = Path('domains')
          yaml_files = list(domains_path.rglob('*.yaml'))

          total_errors = 0
          failed_files = []

          for yaml_file in yaml_files:
              # Skip _meta.yaml files
              if yaml_file.name.endswith('_meta.yaml'):
                  continue

              errors = validate_kb_entry(yaml_file)

              if errors:
                  print(f"‚ùå {yaml_file}")
                  for error in errors:
                      print(f"   - {error}")
                  total_errors += len(errors)
                  failed_files.append(str(yaml_file))
              else:
                  print(f"‚úÖ {yaml_file}")

          if total_errors > 0:
              print(f"\n‚ùå Validation failed with {total_errors} error(s)")
              print(f"   Failed files: {len(failed_files)}")
              sys.exit(1)
          else:
              print(f"\n‚úÖ All {len(yaml_files)} KB entries validated successfully")
          EOF

  validate-python:
    name: Validate Python Tools
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run tests
        run: |
          if [ -d "tests" ]; then
            echo "üîç Running tests..."
            python -m pytest tests/ -v --tb=short || true
          else
            echo "‚ÑπÔ∏è  No tests directory found"
          fi

      - name: Check Python syntax
        run: |
          echo "üîç Checking Python syntax..."

          find tools -name "*.py" -type f | while read file; do
            echo "  Checking $file..."
            if ! python -m py_compile "$file"; then
              echo "  ‚ùå Syntax error in $file"
              exit 1
            else
              echo "  ‚úÖ Valid: $file"
            fi
          done

  quality-check:
    name: Quality Gate Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run quality checks
        run: |
          echo "üîç Running quality gate checks..."

          # Check for required fields in YAML files
          python3 << 'EOF'
          import os
          from pathlib import Path

          domains_path = Path('domains')
          yaml_files = list(domains_path.rglob('*.yaml'))

          issues = []

          for yaml_file in yaml_files:
              if yaml_file.name.endswith('_meta.yaml'):
                  continue

              with open(yaml_file, 'r') as f:
                  content = f.read()

              # Check version field
              if not yaml_file.name.endswith('_meta.yaml'):
                  if 'version:' not in content:
                      issues.append(f"{yaml_file}: Missing version field")

                  # Check category field
                  if 'category:' not in content:
                      issues.append(f"{yaml_file}: Missing category field")

                  # Check last_updated field
                  if 'last_updated:' not in content:
                      issues.append(f"{yaml_file}: Missing last_updated field")

          if issues:
              print("‚ùå Quality check failed:")
              for issue in issues:
                  print(f"  - {issue}")
              exit(1)
          else:
              print("‚úÖ Quality checks passed")
          EOF

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-yaml, validate-python, quality-check]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ YAML Validation: ${{ needs.validate-yaml.result }}" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Python Validation: ${{ needs.validate-python.result }}" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Quality Check: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-yaml.result }}" != "success" ] || \
             [ "${{ needs.validate-python.result }}" != "success" ] || \
             [ "${{ needs.quality-check.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå **Validation Failed**" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the errors above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ **All validations passed!**" >> $GITHUB_STEP_SUMMARY
          fi
