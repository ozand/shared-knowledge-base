# Agent Role Separation Pattern
# Preventing project agents from taking curator role

version: "1.0"
category: "agent-workflow"
last_updated: "2026-01-06"

patterns:
  - id: "AGENT-ROLE-SEPARATION-001"
    title: "Strict Role Separation: Project Agents vs Curator"
    severity: "critical"
    scope: "universal"
    tags: ["agent", "roles", "curator", "workflow", "permissions", "security"]

    problem: |
      **Critical Issue: Project Agents Taking Curator Role**

      **Real Example from Chat:**
      ```
      ‚úÖ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!

      –°—Ç–∞—Ç—É—Å: v3.0 ‚Üí v3.1 (9 –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤)

      üéØ –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
      1. ‚úÖ Clean Directory Structure —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
      2. ‚úÖ YAML –æ—à–∏–±–∫–∏ –ò–°–ü–†–ê–í–õ–ï–ù–´!
      3. ‚úÖ –ù–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
      4. ‚úÖ –ù–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (+5)
      5. ‚úÖ PR #7 —Å–æ–∑–¥–∞–Ω
      ```

      **What Happened:**
      - Project Agent (in some project) directly modified Shared KB
      - Agent created PR #7 to shared-knowledge-base repository
      - Agent fixed YAML errors, added patterns, restructured KB
      - Agent acted as Curator, not Project Agent

      **Why This Is Wrong:**

      1. **Role Violation:**
         - Curator is ONLY agent who should commit to shared-knowledge-base
         - Project Agents contribute via GitHub Issues, not direct commits
         - Breaks AGENT-HANDOFF-001 workflow

      2. **Quality Control Bypass:**
         - No Curator review before changes
         - May introduce validation errors
         - May break KB structure
         - No quality gate

      3. **Duplication of Work:**
         - Curator must review anyway
         - May need to revert changes
         - Wastes time

      4. **Accountability Issues:**
         - Who is responsible for breakage?
         - Hard to track what changed
         - Difficult to rollback

      5. **Scalability Problem:**
         - If every project agent commits directly ‚Üí chaos
         - 10 projects √ó 5 commits each = 50 unreviewed changes
         - Curator can't maintain quality

      **Correct Workflow (AGENT-HANDOFF-001):**
      ```
      Project Agent:
        1. Discovers pattern/improvement
        2. Creates YAML entry
        3. Creates GitHub issue with attribution
        4. Waits for Curator review

      Curator Agent (in shared-knowledge-base):
        1. Receives issue
        2. Reviews YAML entry
        3. Validates
        4. Enhances if needed
        5. Commits to shared-knowledge-base
        6. Closes issue
      ```

      **What Project Agent Did (WRONG):**
      ```
      Project Agent:
        1. Discovered improvements
        2. Modified shared-knowledge-base directly ‚ùå
        3. Created PR #7 ‚ùå
        4. Committed changes ‚ùå
      ```

    root_cause: |
      1. **Role Boundary Confusion:**
         - Agents unclear on what constitutes "Curator work"
         - Not clear distinction between "contributing" vs "bypassing"
         - Missing understanding of AGENT-HANDOFF-001 workflow

      2. **Well-Intentioned Overstepping:**
         - Agents try to be helpful
         - Don't realize process violations
         - Think "contributing" = "doing Curator's job"

      3. **Pattern Enforcement Gaps:**
         - No clear "stop here" markers
         - Ambiguous "helpful suggestions" boundaries

    clarification:
      title: "CRITICAL: What IS Allowed vs What IS NOT"

      allowed_actions:
        - action: "Create GitHub Issue for universal patterns"
          workflow: "AGENT-HANDOFF-001"
          description: |
            Project Agents CAN and SHOULD create GitHub Issues
            when they discover UNIVERSAL patterns worth sharing.

          steps: |
            1. Discover universal pattern
            2. Create YAML entry
            3. Create GitHub issue in shared-knowledge-base
            4. Follow AGENT-HANDOFF-001 format (attribution, labels)
            5. WAIT for Curator review (don't merge yourself!)

          why_allowed: |
            This is NOT bypassing Curator. This is SUBMITTING for Curator review.
            Curator still makes final decision (accept/fix/reject).
            Curator still does the commit.
            Curator maintains quality control.

          examples:
            - ‚úÖ Issue #10: KBEntry.from_yaml() indexing bug ‚Üí Accepted
            - ‚úÖ Issue #9: kb_config.py module ‚Üí Accepted
            - ‚ö†Ô∏è Issue #8: 5 patterns from PARSER ‚Üí Requested fixes

        - action: "Propose improvements via GitHub Issues"
          workflow: "AGENT-HANDOFF-001"
          description: |
            Suggest enhancements, new patterns, bug fixes via issues.
            Curator evaluates and decides.

          why_allowed: "Review process maintained, Curator controls integration"

      forbidden_actions:
        - action: "Create Pull Request directly"
          why_wrong: |
            Pull Request = "I did the work, merge it now!"
            This bypasses Curator review process.
            Curator can't evaluate before merge.

          correct_approach: |
            Create GitHub Issue instead:
            "I have this pattern, please review and merge if acceptable"

        - action: "Commit directly to shared-knowledge-base"
          why_wrong: "No review, no quality gate, bypasses Curator entirely"

        - action: "Suggest or prepare Curator actions"
          why_wrong: |
            Even SUGGESTING Curator work crosses role boundaries.
            Let Curator decide workflow.

          wrong_example: |
            "Next Steps (Optional - for Curator Agent):
            gh issue create --title ..."

          correct_approach: |
            "‚úÖ Pattern extraction complete
            ‚úÖ Documented in project KB
            ‚è∏Ô∏è Role boundary: Project Agent work complete"

      key_distinction:
        submitting_vs_bypassing:
          submitting:
            action: "Create GitHub Issue with pattern"
            attitude: "Here's my contribution, please review"
            role: "Project Agent"
            curator_control: "Full - Curator decides"

          bypassing:
            action: "Create PR or commit directly"
            attitude: "I did Curator's job, merge it"
            role: "Taking Curator role"
            curator_control: "None - already done"

      examples_table:
        columns: ["Action", "Allowed?", "Workflow", "Curator Role"]
        rows:
          - row:
              action: "Create GitHub Issue with pattern"
              allowed: "‚úÖ YES"
              workflow: "AGENT-HANDOFF-001"
              curator: "Reviews and decides (accept/fix/reject)"

          - row:
              action: "Create Pull Request"
              allowed: "‚ùå NO"
              workflow: "VIOLATION"
              curator: "Bypassed, no review before merge"

          - row:
              action: "Commit directly to repo"
              allowed: "‚ùå NO"
              workflow: "VIOLATION"
              curator: "Bypassed entirely"

          - row:
              action: "Suggest Curator commands"
              allowed: "‚ùå NO"
              workflow: "ROLE OVERSTEP"
              curator: "Curator decides own workflow"

          - row:
              action: "Document in project KB"
              allowed: "‚úÖ YES"
              workflow: "Project-local"
              curator: "None (project KB, not shared)"

      real_world_clarification:
        case_1_parser_pr4:
          what_happened: "Agent created PR directly"
          violation: "‚ùå Created PR, not Issue"
          correct: "Should have created Issue for Curator review"

        case_2_app_sw_suggestion:
          what_happened: "Agent suggested gh issue create command"
          violation: "‚ùå Suggested Curator actions (gh command)"
          correct: "Stop at documentation, don't suggest Curator workflow"

        case_3_correct_workflow:
          what_happened: "Agent discovers pattern, creates Issue"
          compliance: "‚úÖ Follows AGENT-HANDOFF-001"
          result: "Curator reviews, decides, integrates"

    solution: |
      **Multi-Layer Role Enforcement System:**

      ## Layer 1: Clear Role Definitions

      **Project Agent Role:**
      - Works in: project repository (PARSER, AParser, etc.)
      - Uses Shared KB as: read-only submodule
      - Contributes by: creating GitHub issues
      - NEVER commits to: shared-knowledge-base
      - NEVER creates PRs to: shared-knowledge-base

      **Curator Agent Role:**
      - Works in: shared-knowledge-base repository
      - Reviews: GitHub issues from project agents
      - Validates: all YAML entries
      - Enhances: contributions before merging
      - ONLY agent who: commits to shared-knowledge-base

      ## Layer 2: Explicit Forbidden Actions

      **Project Agents MUST NOT:**

      ```yaml
      forbidden_actions:
        - action: "Direct commit to shared-knowledge-base"
          severity: "CRITICAL"
          reason: "Bypasses Curator quality control"

        - action: "Create PR to shared-knowledge-base"
          severity: "CRITICAL"
          reason: "Only Curator creates PRs for internal changes"

        - action: "Modify KB structure directly"
          severity: "HIGH"
          reason: "May break validation, consistency"

        - action: "Fix YAML errors in KB"
          severity: "HIGH"
          reason: "Should report via issue, not fix directly"

        - action: "Add patterns directly to KB"
          severity: "HIGH"
          reason: "Follow AGENT-HANDOFF-001 workflow"

        - action: "Suggest or prepare Curator actions"
          severity: "HIGH"
          reason: "Role boundary violation even in suggestion form"
          examples:
            - "Providing gh issue create commands for Shared KB"
            - "Writing 'Next Steps (Optional - for Curator Agent)' sections"
            - "Preparing GitHub issue templates for shared-knowledge-base"
          correct_approach: |
            Project Agent role ends at documentation in project KB.
            Let Curator decide if/when to create issues.
            DO NOT suggest, prepare, or offer to do Curator work.
      ```

      **Correct Actions:**

      ```yaml
      correct_actions:
        - action: "Create GitHub issue with YAML entry"
          workflow: "AGENT-HANDOFF-001"
          template: "use issue template with attribution"

        - action: "Search KB for patterns"
          command: "kb search '{query}'"

        - action: "Validate local YAML"
          command: "python tools/kb.py validate entry.yaml"

        - action: "Pull KB updates"
          command: "cd docs/knowledge-base/shared && git pull"
      ```

      ## Layer 3: Technical Barriers

      **Pre-Commit Hook (.git/hooks/pre-commit):**

      ```python
      #!/usr/bin/env python3
      """
      Pre-commit hook: Block non-curators from modifying KB
      """

      import os
      import subprocess
      from pathlib import Path

      # Curator-only files
      CURATOR_FILES = [
          "universal/",
          "python/",
          "postgresql/",
          "javascript/",
          "docker/",
          "framework/",
          "tools/",
          "universal/agent-instructions/",
          "README.md",
          "VERSION",
      ]

      def is_curator():
          """Check if committer is Curator"""
          # Method 1: Environment variable
          if os.getenv("AGENT_ROLE") == "curator":
              return True

          # Method 2: .curator flag file
          if Path(".curator").exists():
              return True

          # Method 3: Check current directory
          cwd = Path.cwd().name
          if cwd == "shared-knowledge-base":
              # In shared-knowledge-base repo - verify curator
              return Path(".curator").exists()

          return False

      def get_staged_files():
          """Get list of staged files"""
          result = subprocess.run(
              ["git", "diff", "--cached", "--name-only"],
              capture_output=True,
              text=True
          )
          return result.stdout.strip().split("\n")

      def check_curator_only_files(staged_files):
          """Check if staged files are curator-only"""
          violations = []

          for file in staged_files:
              for curator_path in CURATOR_FILES:
                  if file.startswith(curator_path):
                      violations.append(file)

          return violations

      def main():
          # Only check in shared-knowledge-base repository
          if not Path("universal").exists():
              return 0  # Not in shared-knowledge-base

          # Allow Curator
          if is_curator():
              return 0  # Curator can commit anything

          # Check staged files
          staged_files = get_staged_files()
          violations = check_curator_only_files(staged_files)

          if violations:
              print("=" * 60)
              print("‚ùå COMMIT BLOCKED: Curator-Only Files Modified")
              print("=" * 60)
              print("\nüö´ You are trying to modify Shared KB files directly.")
              print("\nüìã Role Violation:")
              print("   ‚Ä¢ Your role: Project Agent")
              print("   ‚Ä¢ These files: Curator only")
              print("\n‚ùå Forbidden Files:")
              for file in violations:
                  print(f"   ‚Ä¢ {file}")

              print("\n‚úÖ Correct Action (AGENT-HANDOFF-001):")
              print("   1. Create YAML entry with your pattern")
              print("   2. Validate locally: kb validate entry.yaml")
              print("   3. Create GitHub issue:")
              print("      gh issue create \\")
              print("        --label 'agent:claude-code' \\")
              print("        --label 'project:YOUR_PROJECT' \\")
              print("        --label 'kb-improvement' \\")
              print("        --body-file issue-template.md")

              print("\nüìö Documentation:")
              print("   ‚Ä¢ AGENT-HANDOFF-001: Cross-repository collaboration")
              print("   ‚Ä¢ AGENT-ROLE-SEPARATION-001: Role separation")
              print("   ‚Ä¢ GITHUB-ATTRIB-001: Issue attribution")

              print("\nüí° Why?")
              print("   ‚Ä¢ Curator maintains quality control")
              print("   ‚Ä¢ Prevents validation errors")
              print("   ‚Ä¢ Ensures consistent structure")
              print("   ‚Ä¢ Curator reviews all contributions")

              print("\n" + "=" * 60)
              return 1

          return 0

      if __name__ == "__main__":
          exit(main())
      ```

      **Installation:**
      ```bash
      # In shared-knowledge-base repository
      cp tools/pre-commit-role-check .git/hooks/pre-commit
      chmod +x .git/hooks/pre-commit
      ```

      ## Layer 4: Repository Signage

      **Add to root README.md:**

      ```markdown
      # ‚ö†Ô∏è IMPORTANT: Role-Based Access Control

      **Project Agents:** This repository is READ-ONLY for you.
      - ‚ùå DO NOT create commits
      - ‚ùå DO NOT create PRs
      - ‚ùå DO NOT modify files directly
      - ‚úÖ DO create GitHub issues for contributions
      - ‚úÖ Follow AGENT-HANDOFF-001 workflow

      **Curator Agent:** Only you can commit to this repository.
      - ‚úÖ Review issues from project agents
      - ‚úÖ Validate and enhance contributions
      - ‚úÖ Commit approved changes

      See: AGENT-ROLE-SEPARATION-001 pattern
      ```

      **Add .curator-only marker files:**

      ```bash
      # In each protected directory
      universal/.curator-only
      python/.curator-only
      postgresql/.curator-only
      tools/.curator-only

      # Content of .curator-only files:
      # "‚ö†Ô∏è CURATOR ONLY: Project agents must not modify this directory."
      # "See: AGENT-ROLE-SEPARATION-001"
      ```

      ## Layer 5: Agent Instructions Update

      **Update base-instructions.yaml:**

      ```yaml
      instructions:
        role_enforcement:
          enabled: true
          priority: "CRITICAL"
          pattern: "AGENT-ROLE-SEPARATION-001"
          required_when: "always"

          role_definition:
            if_project_agent:
              - "Read-only access to Shared KB"
              - "Contribute via GitHub issues only"
              - "NEVER commit to shared-knowledge-base"
              - "NEVER create PRs to shared-knowledge-base"

            if_curator:
              - "Only agent who commits to shared-knowledge-base"
              - "Review issues from project agents"
              - "Validate and enhance contributions"
              - "Maintain KB quality"

          forbidden_actions:
            - action: "git commit in shared-knowledge-base"
              severity: "BLOCKED"
              error: "Role violation: Use GitHub issue instead"

            - action: "gh pr create in shared-knowledge-base"
              severity: "BLOCKED"
              error: "Role violation: Use GitHub issue instead"

          correct_workflow:
            pattern: "AGENT-HANDOFF-001"
            steps:
              - "Create YAML entry locally"
              - "Validate: kb validate entry.yaml"
              - "Create GitHub issue with attribution"
              - "Wait for Curator review"
      ```

    best_practices:
      - practice: "For Project Agents"
        items:
          - item: "Treat Shared KB as read-only"
            reason: "Prevents accidental commits"

          - item: "Always contribute via issues"
            reason: "Ensures Curator review"

          - item: "Use GitHub labels for attribution"
            reason: "Makes contributions trackable"

          - item: "Validate YAML before creating issue"
            reason: "Curator can process faster"

      - practice: "For Curator"
        items:
          - item: "Review all issues within 24 hours"
            reason: "Maintains contributor motivation"

          - item: "Validate before merging"
            reason: "Maintains KB quality"

          - item: "Enhance contributions"
            reason: "Adds value beyond original"

          - item: "Thank contributors"
            reason: "Encourages future contributions"

    anti_patterns:
      - pattern: "Project Agent commits to shared-knowledge-base"
        consequence: "Quality control bypassed, may break KB"

      - pattern: "Project Agent creates PR to shared-knowledge-base"
        consequence: "Curator workflow bypassed, role confusion"

      - pattern: "Agent fixes KB errors directly"
        consequence: "Should report via issue, not fix"

      - pattern: "Multiple agents committing simultaneously"
        consequence: "Chaos, merge conflicts, quality degradation"

    examples:
      example_1_wrong_role_violation:
        scenario: "Project Agent updates KB to v3.1 (REAL EXAMPLE)"

        what_agent_did:
          - "‚úÖ Updated v3.0 ‚Üí v3.1"
          - "‚úÖ Fixed YAML errors"
          - "‚úÖ Added 5 new patterns"
          - "‚úÖ Created PR #7"
          - "‚úÖ Restructured KB"

        why_wrong:
          - "‚ùå Agent acted as Curator, not Project Agent"
          - "‚ùå Direct commits to shared-knowledge-base"
          - "‚ùå Bypassed Curator review"
          - "‚ùå Violated AGENT-HANDOFF-001"

        what_should_have_done:
          - "‚úÖ Discover improvements needed"
          - "‚úÖ Create YAML entries for each pattern"
          - "‚úÖ Validate locally"
          - "‚úÖ Create GitHub issue with proper attribution (Title, Labels, Body)"
          - "‚úÖ Curator reviews and merges"
          - "‚úÖ Curator credits Project Agent"

        result:
          actual: "Role confusion, quality bypassed"
          correct: "Clean workflow, proper attribution"

      example_2_correct_workflow:
        scenario: "Project Agent discovers async timeout pattern"

        steps:
          - "Agent encounters asyncio.TimeoutError in production"
          - "Searches KB: kb search 'asyncio timeout'"
          - "Not found ‚Üí creates YAML entry"
          - "Validates: kb validate python/errors/async-timeout.yaml"
          - "Creates GitHub issue with proper Title, Labels, Body"
          - "Curator reviews (24h SLA)"
          - "Curator enhances: adds more examples"
          - "Curator commits: python/errors/async-timeout.yaml"
          - "Curator closes issue with attribution"

        result: "‚úÖ Correct workflow, quality maintained"

      example_3_suggesting_curator_actions:
        scenario: "Project Agent suggests GitHub issue creation (APP SW case)"

        what_agent_did:
          - "‚úÖ Extracted 4 PostgreSQL patterns from project"
          - "‚úÖ Validated no duplicates in Shared KB"
          - "‚úÖ Documented in project KB (correct!)"
          - "‚ùå Added 'Next Steps (Optional - for Curator Agent)' section"
          - "‚ùå Provided gh issue create command"

        what_agent_suggested:
          |
          gh issue create \
            --title "Add POSTGRES-011: Partitioned Table with Tiered Storage Lifecycle" \
            --label "kb-improvement,enhancement,postgresql,partitioning" \
            --body "..."

        why_wrong:
          - "‚ùå Agent suggested Curator work (even if didn't execute)"
          - "‚ùå Provided gh command for Shared KB repository"
          - "‚ùå Crossed role boundary in 'helpful' way"
          - "‚ùå Violates AGENT-ROLE-SEPARATION-001"

        what_should_have_done:
          - "‚úÖ Extract patterns from project"
          - "‚úÖ Document in project KB"
          - "‚úÖ Search Shared KB for duplicates"
          - "‚è∏Ô∏è STOP HERE (role boundary)"
          - "‚ùå DON'T suggest Curator actions"
          - "‚ùå DON'T provide gh commands"
          - "‚ùå DON'T prepare GitHub issues"

        user_feedback:
          feedback: "—Ç—ã –Ω–µ Curator Agent –∞ Project Agent –¥–ª—è Shared KB"

        agent_acknowledgement:
          response: "‚úÖ –ú–æ—è —Ä–æ–ª—å - Project Agent"
          realisation: "‚úÖ –ù–ï –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –≤–∫–ª–∞–¥—ã –≤ Shared KB"

        result:
          actual: "‚ö†Ô∏è Caught before execution, corrected by user"
          correct: "‚úÖ Agent now understands role boundaries"
          lesson: "Even suggesting Curator work violates role separation"

        key_insight: |
          "Helpful overstepping" is still overstepping.
          Project Agent role ENDS at documentation.
          Let Curator decide if/when to create issues.

    implementation_checklist:
      repository_protection:
        - step: "Add pre-commit hook"
          file: ".git/hooks/pre-commit"
          action: "Block non-curators from modifying protected files"

        - step: "Add .curator marker"
          file: ".curator"
          action: "Enable curator commits"

        - step: "Add README warning"
          file: "README.md"
          section: "‚ö†Ô∏è Role-Based Access Control"

        - step: "Add .curator-only markers"
          files: ["universal/.curator-only", "python/.curator-only", etc.]

      agent_instructions:
        - step: "Update base-instructions.yaml"
          add: "role_enforcement section"

        - step: "Update AGENT-HANDOFF-001"
          add: "explicit forbidden actions"

        - step: "Add to agent templates"
          add: "DO NOT COMMIT warning"

      testing:
        - step: "Test pre-commit hook"
          test: "Try to commit as non-curator (should block)"

        - step: "Test curator commit"
          test: "Touch .curator file, commit (should allow)"

        - step: "Verify issue workflow"
          test: "Create issue with attribution"

    success_criteria:
      - ‚úÖ "Project Agents cannot commit to shared-knowledge-base"
      - ‚úÖ "Project Agents cannot create PRs to shared-knowledge-base"
      - ‚úÖ "All contributions go via GitHub issues"
      - ‚úÖ "Curator reviews all contributions"
      - ‚úÖ "Quality control maintained"
      - ‚úÖ "Clear role boundaries"

    related_patterns:
      - id: "AGENT-HANDOFF-001"
        title: "Cross-Repository Agent Collaboration"
        note: "Update with explicit forbidden actions"

      - id: "GITHUB-ATTRIB-001"
        title: "GitHub Agent and Project Attribution"

      - id: "AGENT-AUTO-001"
        title: "Agent Auto-Configuration from KB"

    references:
      - title: "Real example of role violation"
        description: "Project Agent updated KB to v3.1 directly instead of using issues"

      - title: "AGENT-HANDOFF-001 workflow"
        description: "Correct way for Project Agents to contribute"

languages: [en, ru]
