# Agent Auto-Configuration Pattern
# Automatic discovery and application of KB instructions by agents

version: "1.0"
category: "agent-workflow"
last_updated: "2026-01-06"

patterns:
  - id: "AGENT-AUTO-001"
    title: "Agent Auto-Configuration from Knowledge Base"
    severity: "high"
    scope: "universal"
    tags: ["agent", "automation", "configuration", "bootstrap", "kb-integration"]

    problem: |
      **Manual Configuration Problem:**

      Current approach requires manual setup for each agent:
      - System prompts must be manually updated per agent
      - Project names must be manually configured
      - Agent types must be manually specified
      - Instructions must be manually distributed to all agents
      - Updates require re-configuring all agents

      **Real Example:**
      To add GITHUB-ATTRIB-001 to 10 projects:
      - Update 10 system prompts manually
      - Create project labels manually
      - Test each agent individually
      - Result: 2-3 hours of manual work

      **Scalability Issues:**
      - New project created ‚Üí manual setup required
      - KB updated ‚Üí agents don't know about changes
      - New pattern added ‚Üí agents can't use it automatically
      - Manual approach doesn't scale beyond 5-10 projects

      **Desired State:**
      - Deploy Shared KB to project ‚Üí agents auto-configure
      - Update Shared KB ‚Üí agents get updates automatically
      - Create new project ‚Üí agent sets up itself
      - Zero manual configuration required

    solution: |
      **Self-Configuring Agent System:**

      ## Phase 1: Auto-Discovery

      **Agent automatically detects:**

      1. **Agent Type:**
         ```bash
         # From environment or capabilities
         export AGENT_TYPE="claude-code"  # or cursor-ai, copilot, etc.
         ```

      2. **Project Name:**
         ```bash
         # From git remote
         git remote get-url origin
         # ‚Üí git@github.com:user/PARSER.git
         # ‚Üí Extract: PARSER
         ```

         **Or from config files:**
         - `package.json` ‚Üí `name` field
         - `pyproject.toml` ‚Üí `project.name`
         - `Cargo.toml` ‚Üí `package.name`
         - `.agent-config` ‚Üí explicit project name

      3. **Agent Role:**
         ```python
         # From task context
         role = detect_task_type(task)
         # ‚Üí "code-generation", "debugging", "refactoring", etc.
         ```

      4. **Shared KB Location:**
         ```bash
         # Search in known locations
         - docs/knowledge-base/shared/
         - .shared-kb/
         - knowledge-base/
         - KB_PATH environment variable
         ```

      ## Phase 2: Bootstrap Process

      **Agent on startup:**

      ```python
      def bootstrap_agent():
          """Called when agent starts"""

          # 1. Detect context
          context = detect_context()

          # 2. Find Shared KB
          kb_path = find_knowledge_base()

          # 3. Load base instructions
          instructions = load_agent_instructions(kb_path)

          # 4. Apply instructions
          apply_instructions(instructions, context)

          # 5. Register capabilities
          register_capabilities(instructions)

          return context
      ```

      ## Phase 3: Instruction Loading

      **From Shared KB:**

      ```yaml
      # universal/agent-instructions/base-instructions.yaml
      version: "1.0"
      last_updated: "2026-01-06"

      applies_to: "all_agents"

      instructions:

        github_attribution:
          pattern: "GITHUB-ATTRIB-001"
          enabled: true
          required_when: "creating_issues_or_prs"

          steps:
            - "Add 'Created By' section at top of issue body"
            - "Use labels: agent:{agent_type}, project:{project_name}"
            - "Follow template in KB"

          template_path: "universal/agent-instructions/templates/issue-template.md"

        kb_contribution:
          pattern: "AGENT-HANDOFF-001"
          enabled: true
          required_when: "contributing_to_shared_kb"

          steps:
            - "Search KB before creating new pattern"
            - "Validate YAML before creating issue"
            - "Use GitHub issue with attribution"
            - "Wait for Curator review"

        quality_standards:
          pattern: "various"
          enabled: true
          required_when: "always"

          standards:
            - "Follow YAML-001 for YAML syntax"
            - "Use ISOLATED-TEST-001 for PR testing"
            - "Apply AGENT-ACCOUNTABILITY-001"

      # Auto-generated for each agent
      context:
        agent_type: "{{auto_detected}}"
        project_name: "{{auto_detected}}"
        session_id: "{{auto_generated}}"
      ```

      ## Phase 4: Auto-Update on KB Changes

      **When Shared KB is updated:**

      ```python
      def on_kb_update(kb_path):
          """Called when KB git pull happens"""

          # 1. Check instruction version
          new_version = read_version(kb_path)
          old_version = read_cached_version()

          if new_version > old_version:
              # 2. Load new instructions
              new_instructions = load_agent_instructions(kb_path)

              # 3. Notify agent
              notify_agent(
                  "KB updated. New instructions available.",
                  changes=diff_instructions(old_instructions, new_instructions)
              )

              # 4. Re-configure if needed
              if new_instructions.requires_reconfigure:
                  apply_instructions(new_instructions, detect_context())
          ```

      ## Phase 5: Capability Registration

      **Agent discovers what it can do:**

      ```python
      # From instructions
      capabilities = {
          "create_github_issue": {
              "enabled": true,
              "attribution_required": true,
              "labels": ["agent:*", "project:*", "agent-type:*"]
          },
          "contribute_to_kb": {
              "enabled": true,
              "validation_required": true,
              "workflow": "AGENT-HANDOFF-001"
          }
      }
      ```

    implementation:

      knowledge_base_structure: |
        # Shared KB should contain:

        universal/agent-instructions/
          ‚îú‚îÄ‚îÄ base-instructions.yaml          # Base instructions for all agents
          ‚îú‚îÄ‚îÄ context-detection.yaml           # How to detect context
          ‚îú‚îÄ‚îÄ templates/
          ‚îÇ   ‚îú‚îÄ‚îÄ issue-template.md
          ‚îÇ   ‚îú‚îÄ‚îÄ pr-template.md
          ‚îÇ   ‚îî‚îÄ‚îÄ comment-template.md
          ‚îî‚îÄ‚îÄ patterns/
              ‚îú‚îÄ‚îÄ github-attribution.yaml      # GITHUB-ATTRIB-001
              ‚îú‚îÄ‚îÄ agent-handoff.yaml           # AGENT-HANDOFF-001
              ‚îî‚îÄ‚îÄ agent-accountability.yaml    # AGENT-ACCOUNTABILITY-001

        tools/
          ‚îî‚îÄ‚îÄ kb-agent-bootstrap.py            # Bootstrap script

      bootstrap_script: |
        #!/usr/bin/env python3
        """
        Agent Bootstrap Script
        Run this when agent starts to auto-configure from Shared KB
        """

        import os
        import subprocess
        import json
        from pathlib import Path

        def detect_project_name():
            """Auto-detect project name from git or config"""
            # Try git remote
            try:
                result = subprocess.run(
                    ["git", "remote", "get-url", "origin"],
                    capture_output=True, text=True, check=True
                )
                url = result.stdout.strip()
                # Extract: git@github.com:user/PARSER.git ‚Üí PARSER
                if url.endswith(".git"):
                    url = url[:-4]
                return url.split("/")[-1]
            except:
                pass

            # Try package.json
            package_json = Path("package.json")
            if package_json.exists():
                with open(package_json) as f:
                    data = json.load(f)
                    return data.get("name", "unknown")

            # Try pyproject.toml
            pyproject = Path("pyproject.toml")
            if pyproject.exists():
                # Parse TOML (simplified)
                with open(pyproject) as f:
                    for line in f:
                        if line.startswith("name = "):
                            return line.split("=")[1].strip().strip('"')

            # Try .agent-config
            config = Path(".agent-config")
            if config.exists():
                with open(config) as f:
                    data = json.load(f)
                    return data.get("project_name", "unknown")

            return "unknown"

        def detect_agent_type():
            """Detect agent type from environment or config"""
            # Environment variable
            agent_type = os.getenv("AGENT_TYPE")
            if agent_type:
                return agent_type

            # From .agent-config
            config = Path(".agent-config")
            if config.exists():
                with open(config) as f:
                    data = json.load(f)
                    return data.get("agent_type", "claude-code")

            # Default
            return "claude-code"

        def find_knowledge_base():
            """Find Shared KB in standard locations"""
            locations = [
                Path("docs/knowledge-base/shared"),
                Path(".shared-kb"),
                Path("knowledge-base"),
                Path(os.getenv("KB_PATH", "")),
            ]

            for location in locations:
                if location.exists() and (location / "universal").exists():
                    return location

            return None

        def load_instructions(kb_path):
            """Load agent instructions from KB"""
            instructions_file = kb_path / "universal/agent-instructions/base-instructions.yaml"

            if not instructions_file.exists():
                return {}

            # Parse YAML (simplified)
            import yaml
            with open(instructions_file) as f:
                return yaml.safe_load(f)

        def apply_instructions(instructions, context):
            """Apply instructions to agent configuration"""
            if not instructions:
                return

            # Build configuration
            config = {
                "agent_type": context["agent_type"],
                "project_name": context["project_name"],
                "session_id": context.get("session_id", "unknown"),
                "capabilities": {}
            }

            # Process instruction groups
            for group, settings in instructions.get("instructions", {}).items():
                if settings.get("enabled", False):
                    config["capabilities"][group] = {
                        "pattern": settings.get("pattern"),
                        "required_when": settings.get("required_when"),
                        "steps": settings.get("steps", [])
                    }

            # Save to .agent-config.local (auto-generated, don't commit)
            with open(".agent-config.local", "w") as f:
                json.dump(config, f, indent=2)

            return config

        def main():
            """Bootstrap agent from Shared KB"""
            print("ü§ñ Agent Bootstrap: Starting...")

            # Detect context
            project_name = detect_project_name()
            agent_type = detect_agent_type()

            print(f"  ‚Üí Project: {project_name}")
            print(f"  ‚Üí Agent Type: {agent_type}")

            # Find KB
            kb_path = find_knowledge_base()
            if not kb_path:
                print("‚ö†Ô∏è  Shared KB not found. Using default configuration.")
                return

            print(f"  ‚Üí KB Path: {kb_path}")

            # Load instructions
            instructions = load_instructions(kb_path)
            if not instructions:
                print("‚ö†Ô∏è  No instructions found in KB.")
                return

            print(f"  ‚Üí Instructions version: {instructions.get('last_updated', 'unknown')}")

            # Apply instructions
            context = {
                "agent_type": agent_type,
                "project_name": project_name,
                "session_id": os.getenv("AGENT_SESSION", "auto-generated")
            }

            config = apply_instructions(instructions, context)

            print(f"‚úÖ Bootstrap complete. Configuration saved to .agent-config.local")
            print(f"   Capabilities: {list(config.get('capabilities', {}).keys())}")

        if __name__ == "__main__":
            main()

      auto_update_hook: |
        # Add to agent's update cycle

        def check_kb_updates():
            """Check if KB has new instructions"""
            kb_path = find_knowledge_base()
            if not kb_path:
                return

            # Get current KB version
            version_file = kb_path / ".kb-version"
            if version_file.exists():
                with open(version_file) as f:
                    current_version = f.read().strip()
            else:
                current_version = "0"

            # Check for updates (git fetch)
            subprocess.run(["git", "-C", kb_path, "fetch"], check=False)

            # Get latest version
            try:
                latest_version = subprocess.run(
                    ["git", "-C", kb_path, "rev-parse", "origin/main"],
                    capture_output=True, text=True, check=True
                ).stdout.strip()
            except:
                return

            if latest_version != current_version:
                # Update KB
                subprocess.run(["git", "-C", kb_path, "pull"], check=True)

                # Reload instructions
                new_instructions = load_instructions(kb_path)

                # Re-configure if needed
                if new_instructions.get("requires_reconfigure", False):
                    print("üîÑ KB updated. Re-configuring...")
                    apply_instructions(new_instructions, detect_context())

                # Save new version
                with open(version_file, "w") as f:
                    f.write(latest_version)

      configuration_file: |
        # .agent-config (commit to repo, overrides)

        {
          "project_name": "PARSER",
          "agent_type": "claude-code",
          "kb_path": "docs/knowledge-base/shared",
          "auto_update": true,
          "features": {
            "github_attribution": true,
            "kb_contribution": true
          }
        }

      integration_points:

        agent_startup: |
          # Call this when agent initializes

          python -c "
          import sys
          sys.path.insert(0, 'docs/knowledge-base/shared/tools')
          from kb_agent_bootstrap import bootstrap_agent
          bootstrap_agent()
          "

        agent_task_start: |
          # Before each task, check context

          context = load_agent_config()
          if task_type == "create_github_issue":
              if context["capabilities"]["github_attribution"]["enabled"]:
                  apply_github_attribution(context)

        agent_periodic: |
          # Check for KB updates every hour

          while True:
              check_kb_updates()
              time.sleep(3600)

    best_practices:
      - practice: "Store all agent instructions in Shared KB"
        reason: "Single source of truth, auto-distributed"

      - practice: "Auto-detect project context"
        reason: "Zero manual configuration"

      - practice: "Use .agent-config for overrides"
        reason: "Allows project-specific customization"

      - practice: "Check for KB updates periodically"
        reason: "Agents automatically get new patterns"

      - practice: "Version instructions"
        reason: "Track when agents need updates"

    anti_patterns:
      - pattern: "Hardcode agent config in system prompts"
        consequence: "Manual updates required, doesn't scale"

      - pattern: "Copy instructions to each project"
        consequence: "Duplication, sync issues"

      - pattern: "Manual project name configuration"
        consequence: "Forget to configure, wrong attribution"

      - pattern: "Static instructions that never update"
        consequence: "Agents miss new KB patterns"

    examples:
      example_1_new_project_setup:
        scenario: "Create new project with Shared KB"

        steps: |
          1. Create project: my-new-project
          2. Add Shared KB as submodule:
             git init
             git submodule add git@github.com:user/shared-knowledge-base.git docs/knowledge-base/shared
          3. Create .agent-config (optional):
             {"project_name": "my-new-project"}
          4. Start agent - it auto-bootstraps from KB
          5. Agent knows:
             - GitHub attribution (GITHUB-ATTRIB-001)
             - KB contribution workflow (AGENT-HANDOFF-001)
             - Quality standards (YAML-001, ISOLATED-TEST-001)
          6. Zero manual system prompt changes needed

        result: "Agent fully configured in 5 minutes"

      example_2_kb_update:
        scenario: "Add new pattern to Shared KB"

        steps: |
          1. Update Shared KB:
             - Add new pattern: universal/patterns/NEW-PATTERN.yaml
             - Update base-instructions.yaml
             - Commit and push
          2. Projects pull KB updates:
             cd docs/knowledge-base/shared && git pull
          3. Agents detect new instructions:
             - check_kb_updates() finds new version
             - Load new instructions
             - Apply new capabilities
          4. Agents start using new pattern immediately

        result: "All agents get new pattern automatically"

      example_3_auto_context_detection:
        scenario: "Agent determines project name automatically"

        detection_methods:
          - method: "Git remote"
            command: "git remote get-url origin"
            example: "git@github.com:user/PARSER.git ‚Üí PARSER"

          - method: "package.json"
            field: "name"
            example: '"name": "my-app" ‚Üí my-app'

          - method: "pyproject.toml"
            field: "project.name"
            example: "name = 'my-project' ‚Üí my-project"

          - method: ".agent-config"
            field: "project_name"
            example: 'Explicit override'

        fallback: "unknown"

    success_criteria:
      - ‚úÖ "Deploy KB ‚Üí agents auto-configure"
      - ‚úÖ "Update KB ‚Üí agents get updates"
      - ‚úÖ "Zero manual system prompt editing"
      - ‚úÖ "Auto-detect project context"
      - ‚úÖ "Single source of truth in KB"

    related_patterns:
      - id: "GITHUB-ATTRIB-001"
        title: "GitHub Agent and Project Attribution"

      - id: "AGENT-HANDOFF-001"
        title: "Cross-Repository Agent Collaboration"

      - id: "AGENT-ACCOUNTABILITY-001"
        title: "Agent Self-Accountability"

    implementation_checklist:
      setup:
        - step: "Add agent-instructions/ to KB"
          file: "universal/agent-instructions/base-instructions.yaml"

        - step: "Create bootstrap script"
          file: "tools/kb-agent-bootstrap.py"

        - step: "Add templates"
          file: "universal/agent-instructions/templates/*.md"

        - step: "Test bootstrap"
          command: "python tools/kb-agent-bootstrap.py"

      project_integration:
        - step: "Add Shared KB as submodule"
          command: "git submodule add <kb-url> docs/knowledge-base/shared"

        - step: "Run bootstrap once"
          command: "python docs/knowledge-base/shared/tools/kb-agent-bootstrap.py"

        - step: "Verify .agent-config.local created"
          check: "cat .agent-config.local"

        - step: "Test agent capabilities"
          test: "Create GitHub issue with attribution"

      maintenance:
        - step: "Update KB instructions when needed"
          trigger: "New pattern or workflow"

        - step: "Version instruction changes"
          method: "Update last_updated field"

        - step: "Test with existing projects"
          verify: "Agents pick up changes"

languages: [en, ru]
