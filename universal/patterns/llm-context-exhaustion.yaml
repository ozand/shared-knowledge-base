# Large Language Model Context Management Pattern
# Strategies for handling context window limits in long AI conversations

version: "1.0"
category: "workflow"
last_updated: "2025-01-06"

patterns:
  - id: "LLM-CONTEXT-001"
    title: "Large Language Model Context Exhaustion Management"
    severity: "high"
    scope: "universal"
    tags: ["context", "llm", "memory", "limits", "continuity", "session", "claude", "gpt-4"]

    problem: |
      Long conversations with AI assistants (Claude, GPT-4, etc.) eventually hit
      context window limits, causing the model to lose early conversation history.

      This happens when:
      - Working on complex multi-step tasks
      - Long debugging sessions
      - Extensive code refactoring
      - Large file analysis

      Symptoms:
      - AI assistant forgets earlier parts of conversation
      - Contradicts previous statements
      - Loses track of project structure
      - Asks for context already provided
      - "Let me check what we discussed earlier" (but can't)

    root_cause: |
      1. **Context window limits**: Most LLMs have limited token context (128k-200k tokens)
      2. **Token accumulation**: Every user message and AI response consumes tokens
      3. **No context persistence**: Early messages are dropped when limit reached
      4. **Hidden context cost**: System prompts and tools consume invisible tokens

    solution: |
      **Immediate Workaround:**

      When context exhaustion occurs:

      1. **Create summary document**:
         ```markdown
         # Context Summary

         ## Project Status
         - What we're working on
         - Current state
         - Completed steps

         ## Key Decisions Made
         - Decision 1: ...
         - Decision 2: ...

         ## Important Context
         - Project structure
         - File locations
         - Technical constraints

         ## Next Steps
         - Step 1: ...
         - Step 2: ...
         ```

      2. **Start new conversation** with summary:
         "I'm continuing work on [project]. Here's the context summary: [paste summary]"

      **Long-term Solutions:**

      **Option A: Create Context Files**
      ```markdown
      # CONTEXT.md

      ## Project Overview
      Brief description

      ## Current Task
      What we're working on now

      ## Key Files
      - file1.ts - Purpose
      - file2.ts - Purpose

      ## Important Decisions
      List of decisions made

      ## Next Steps
      What to do next
      ```

      **Option B: Use Smaller Tasks**
      - Break large tasks into smaller chunks
      - Complete one chunk per conversation
      - Save progress between conversations

      **Option C: Reference Documentation**
      - Keep detailed docs in project
      - Reference docs: "See CONTEXT.md for background"
      - Point to specific sections: "As documented in docs/guides/PATTERN_LIBRARY.md"

      **Option D: Regular Summarization**
      Every 50-100 messages, create summary:
      ```markdown
      <!-- SESSION SUMMARY -->

      What we accomplished:
      - âœ… Step 1
      - âœ… Step 2

      Current state:
      - Files created/modified
      - Decisions made
      - Next steps

      Context for next session:
      - Important variables
      - File locations
      - Technical details
      ```

    prevention: |
      1. **Create comprehensive documentation**
         - PROJECT.md with overview
         - CONTEXT.md with current session
         - README.md in each directory

      2. **Use summaries**
         - Every major milestone
         - When switching contexts
         - Before context gets full

      3. **Break into smaller tasks**
         - Each task < 100 messages ideally
         - Document between tasks
         - Clear deliverables

      4. **Reference existing docs**
         - "See docs/guides/PATTERN_LIBRARY.md section 5.2"
         - "As documented in CONTEXT.md"
         - Keep docs up to date

      5. **Create session checkpoints**
         - Mark progress in docs
         - Use TODO lists
         - Track completed steps

    code_example: |
      ```markdown
      # Session Context - Phase 5 Integration

      **Date**: 2025-01-06
      **Session**: 3 of 3 (Final Phase)

      ## What We're Doing
      Integrating Shared Knowledge Base into PARSER project

      ## Completed This Session
      âœ… Phase 1: Cloned Shared KB
      âœ… Phase 2: Setup tools and structure
      âœ… Phase 3: Created 6 PARSER entries
      âœ… Phase 4: Updated AGENTS.md and SKILLS.md
      âœ… Phase 5: Created documentation

      ## Key Files Created
      - docs/knowledge-base/shared/ (1.7 MB)
      - docs/knowledge-base/project/aparser/errors.yaml
      - docs/knowledge-base/README.md
      - SHARED_KB_INTEGRATION_COMPLETE.md

      ## Important Decisions
      - Used plain clone (not submodule) - project not under git
      - Created 6 entries: APARSER-001, APARSER-002, TS-001, etc.
      - Added KB Curator as 6th agent
      - Added Knowledge Base Usage as 15th skill

      ## Next Session (If Needed)
      1. Fix YAML format for proper indexing
      2. Create more entries as errors discovered
      3. Contribute reusable patterns to Shared KB

      ## Quick Reference
      ```bash
      # Search KB
      python docs/knowledge-base/tools/kb.py search "error"

      # Stats
      python docs/knowledge-base/tools/kb.py stats

      # Validate
      python docs/knowledge-base/tools/kb.py validate entry.yaml
      ```
      ```

    best_practices: |
      1. **Document early, document often**
         - Create docs at project start
         - Update as you go
         - Reference existing docs

      2. **Use summaries strategically**
         - Before context gets 80% full
         - After completing major phases
         - When switching tasks

      3. **Keep documentation current**
         - Update docs as decisions made
         - Mark progress clearly
         - Use TODO lists

      4. **Make documentation findable**
         - Clear file names (CONTEXT.md, STATUS.md)
         - Table of contents
         - Cross-references

      5. **Use visual indicators**
         - âœ… for completed
         - ðŸ”„ for in-progress
         - â³ for pending
         - âŒ for blocked

    lessons_learned: |
      **From this session:**
      - 50+ message exchanges consumed significant context
      - Created multiple summary documents throughout
      - TodoWrite tool helped track progress
      - Final summary ensures continuity

      **What worked well:**
      - TodoWrite for task tracking
      - Creating summary docs (SHARED_KB_INTEGRATION_COMPLETE.md)
      - Breaking into 6 clear phases
      - Regular status updates

      **What could be better:**
      - Create CONTEXT.md at start
      - More frequent summaries
      - Smaller task chunks

    tools_and_techniques: |
      1. **TodoWrite tool** (Claude Code)
         - Track multi-phase tasks
         - Mark progress clearly
         - Resume after breaks

      2. **Summary documents**
         - PROJECT_REORGANIZATION_PLAN.md
         - REORGANIZATION_SUMMARY.md
         - SHARED_KB_INTEGRATION_COMPLETE.md

      3. **Progress tracking in docs**
         - Checklists: âœ… Complete, â³ Pending
         - Phase markers: Phase 1, Phase 2, etc.
         - Status indicators: Completed, In Progress

      4. **Context preservation**
         - Document decisions made
         - Record file locations
         - Note technical constraints
         - Save code snippets

    anti_patterns: |
      âŒ **Don't rely on AI memory**
      - AI will forget earlier context
      - Cannot retrieve dropped messages
      - Each session is fresh start

      âŒ **Don't assume continuity**
      - New session = blank slate
      - Must provide context
      - Reference previous work

      âŒ **Don't skip documentation**
      - Docs are your backup memory
      - Essential for continuity
      - Critical for complex projects

    when_to_use: |
      Use this pattern when:
      - Working on complex multi-step tasks
      - Long debugging sessions (>50 messages)
      - Extensive code refactoring
      - Large file analysis
      - Multi-phase project organization

    related_patterns:
      - "DOC-REORG-001" (Documentation Reorganization)
      - "AI-SERVICE-001" (AI Service Files Updates)

    references:
      - "SHARED_KB_INTEGRATION_COMPLETE.md" (Session summary)
      - "PROJECT_REORGANIZATION_PLAN.md" (Task breakdown)
      - "REORGANIZATION_SUMMARY.md" (Progress report)

    metadata:
      created_at: "2025-01-06"
      author: "PARSER project"
      reusable: true
      severity_level: 1
      difficulty: "elementary"
      pattern_type: "workflow"
      applicable_to: ["claude", "gpt-4", "gemini", "llama"]
