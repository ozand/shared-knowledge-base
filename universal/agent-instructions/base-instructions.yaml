# Base Agent Instructions
# Auto-loaded by all agents from Shared KB

version: "1.0"
last_updated: "2026-01-06"
applies_to: "all_agents"

metadata:
  pattern: "AGENT-AUTO-001"
  description: "Base instructions that all agents auto-load from Shared KB"
  auto_reload: true
  requires_reconfigure: false

instructions:

  # GitHub Attribution
  github_attribution:
    enabled: true
    priority: "HIGH"
    pattern: "GITHUB-ATTRIB-001"
    required_when: "creating_github_issues_or_prs"

    description: |
      When creating GitHub Issues or PRs, add attribution to make
      the agent and project visible in the GitHub UI.

    steps:
      - step: "Add 'Created By' section at VERY TOP of issue/PR body"
        template: "universal/agent-instructions/templates/issue-header.md"

      - step: "Use GitHub labels for filterable attribution"
        labels:
          - "agent:{agent_type}"  # claude-code, cursor-ai, copilot, curator
          - "project:{project_name}"  # Auto-detected from git/config
          - "agent-type:{task_type}"  # code-generation, debugging, etc.
          - "kb-improvement"  # For KB contributions
          - "{category}"  # python, postgresql, docker, etc.

      - step: "Include detailed metadata section"
        template: "universal/agent-instructions/templates/metadata-section.md"

    context_variables:
      - name: "agent_type"
        source: "auto_detect_or_env"
        env_var: "AGENT_TYPE"
        default: "claude-code"

      - name: "project_name"
        source: "auto_detect_from_git_or_config"
        detection_methods:
          - method: "git remote"
            command: "git remote get-url origin"
            extract: "Get last part of path"

          - method: "package.json"
            file: "package.json"
            field: "name"

          - method: "pyproject.toml"
            file: "pyproject.toml"
            field: "project.name"

          - method: ".agent-config"
            file: ".agent-config"
            field: "project_name"

        default: "unknown"

      - name: "agent_session"
        source: "auto_generate_or_env"
        env_var: "AGENT_SESSION"
        default: "session-{timestamp}"

      - name: "task_type"
        source: "detect_from_task_context"
        options:
          - "code-generation"
          - "debugging"
          - "refactoring"
          - "documentation"
          - "review"

    examples:
      - scenario: "Creating KB contribution issue"
        cli_command: |
          gh issue create \
            --label "agent:{agent_type}" \
            --label "project:{project_name}" \
            --label "agent-type:{task_type}" \
            --label "kb-improvement" \
            --title "Add PYTHON-XXX: Pattern Name" \
            --body-file issue-template.md

    quality_checks:
      - check: "Issue body has 'Created By' at first line"
        pass_if: "body.startswith('---\\n**Created By:**')"

      - check: "All required labels present"
        pass_if: "labels contain 'agent:*' and 'project:*'"

  # KB Contribution Workflow
  kb_contribution:
    enabled: true
    priority: "HIGH"
    pattern: "AGENT-HANDOFF-001"
    required_when: "contributing_patterns_to_shared_kb"

    description: |
      When contributing reusable error patterns or best practices to
      Shared Knowledge Base, follow the agent handoff workflow.

    steps:
      - step: "Search KB for existing patterns"
        command: "kb search '{pattern_keywords}'"
        verify: "If pattern exists, don't create duplicate"

      - step: "Create YAML entry following KB template"
        template: "Use KB template structure"
        validate: "python tools/kb.py validate entry.yaml"

      - step: "Create GitHub issue with attribution"
        workflow: "Follow GITHUB-ATTRIB-001"

      - step: "Wait for Curator review"
        expected_sla: "24 hours"

      - step: "Pull KB updates after merge"
        command: "cd docs/knowledge-base/shared && git pull"

    quality_standards:
      - standard: "YAML-001"
        description: "Follow YAML syntax best practices"
        validate: "python tools/kb.py validate"

      - standard: "GITHUB-ATTRIB-001"
        description: "Use proper attribution"
        verify: "Check labels and 'Created By' section"

    examples:
      - scenario: "Contributing error pattern"
        workflow: |
          1. Encounter error
          2. Search KB: kb search "error"
          3. Not found â†’ Create YAML
          4. Validate: kb validate pattern.yaml
          5. Create issue with attribution
          6. Curator reviews and merges
          7. Pull updates

  # Quality Standards
  quality_standards:
    enabled: true
    priority: "MEDIUM"
    pattern: "various"
    required_when: "always"

    standards:

      yaml_syntax:
        pattern: "YAML-001"
        description: "Common YAML syntax errors to avoid"
        applies_to: "creating_or_editing_yaml_files"

        rules:
          - rule: "Validate YAML before committing"
            command: "python tools/kb.py validate {file}"

          - rule: "Quote colons in mapping values"
            example: 'description: "error: something failed"'

          - rule: "Use consistent indentation"
            recommendation: "Use 2 spaces, no tabs"

          - rule: "Escape special characters"
            examples:
              - "\\n for newline"
              - "\\t for tab"
              - "\\\\ for backslash"

      isolated_testing:
        pattern: "ISOLATED-TEST-001"
        description: "Test in isolated environment, never in main repo"
        applies_to: "testing_pull_requests"

        strategies:
          - strategy: "Temporary clone (RECOMMENDED)"
            command: |
              cd /tmp && rm -rf pr-test && mkdir pr-test && cd pr-test
              git clone git@github.com:user/repo.git .
              git fetch origin pull/{number}/head:pr-branch
              git checkout pr-branch
              # Run tests
            cleanup: "rm -rf /tmp/pr-test"

          - strategy: "Git worktree"
            command: "git worktree add ../pr-test pr-branch"

      agent_accountability:
        pattern: "AGENT-ACCOUNTABILITY-001"
        description: "Follow your own recommendations"
        applies_to: "all_actions"

        workflow:
          - "Before acting: Search KB for relevant patterns"
          - "While acting: Follow documented best practices"
          - "After acting: Verify you followed your own recommendations"

        self_check_questions:
          - question: "Did I search KB before acting?"
          - question: "Am I following documented patterns?"
          - question: "Should I update docs based on this experience?"

      pr_review:
        pattern: "PR-REVIEW-001"
        description: "Review all PRs before merge"
        applies_to: "curator_agent_reviewing_prs"

        process:
          - "Test PR in isolated environment"
          - "Validate all YAML files"
          - "Check quality standards compliance"
          - "Provide clear feedback"

  # Documentation Practices
  documentation:
    enabled: true
    priority: "LOW"
    pattern: "DOC-SYNC-001"
    required_when: "updating_documentation"

    description: |
      When updating documentation, ensure all related files are updated
      consistently.

    steps:
      - step: "Map documentation dependencies"
        description: "Identify which files reference the documentation"

      - step: "Create update checklist"
        description: "List all files that need updates"

      - step: "Update files systematically"
        description: "Follow dependency order"

      - step: "Verify consistency"
        description: "Check cross-references and terminology"

    examples:
      - scenario: "Adding new Curator responsibility"
        files_to_update:
          - "curator/AGENT.md"
          - "curator/SKILLS.md"
          - "curator/WORKFLOWS.md"
          - "universal/patterns/pr-review-process.yaml"

# Agent capabilities registry
# Agents discover what they can do from this list
capabilities:
  github_operations:
    create_issue:
      enabled: true
      requires_attribution: true
      template: "universal/agent-instructions/templates/issue-template.md"

    create_pr:
      enabled: true
      requires_attribution: true
      template: "universal/agent-instructions/templates/pr-template.md"

    add_comment:
      enabled: true
      attribution_format: "**_Comment by ðŸ¤– {agent} ({project})_**"

  kb_operations:
    search:
      enabled: true
      command: "kb search '{query}'"

    validate:
      enabled: true
      command: "python tools/kb.py validate {file}"

    contribute:
      enabled: true
      workflow: "AGENT-HANDOFF-001"
      requires_attribution: true

# Context detection rules
context_detection:
  agent_type:
    methods:
      - source: "environment"
        variable: "AGENT_TYPE"

      - source: "config_file"
        file: ".agent-config"
        field: "agent_type"

      - source: "default"
        value: "claude-code"

  project_name:
    methods:
      - source: "git"
        command: "git remote get-url origin"
        extract: "project_name_from_url"

      - source: "package_json"
        file: "package.json"
        field: "name"

      - source: "pyproject_toml"
        file: "pyproject.toml"
        field: "project.name"

      - source: "config_file"
        file: ".agent-config"
        field: "project_name"

      - source: "default"
        value: "unknown"

  session_id:
    methods:
      - source: "environment"
        variable: "AGENT_SESSION"

      - source: "generate"
        format: "session-{timestamp}-{random}"

# Auto-update configuration
auto_update:
  enabled: true
  check_interval: "1h"
  method: "git_pull"

  on_update:
    reload_instructions: true
    notify_agent: true
    reconfigure_if: "version_mismatch"

# Version tracking
version:
  current: "1.0"
  last_updated: "2026-01-06"
  backward_compatible: true
  deprecation_notice: null
