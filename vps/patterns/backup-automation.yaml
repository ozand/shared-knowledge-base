# Backup and Restore Patterns
# Automated backup strategies for VPS configurations and data

version: "1.0"
category: "backup-automation"
last_updated: "2026-01-05"

patterns:
  - id: "VPS-BKP-001"
    title: "Automated Backup to Offsite Location via Tailscale"
    severity: "critical"
    scope: "vps"

    description: |
      Implement automated backup system that copies critical configurations
      to home server via Tailscale mesh VPN for safe offsite storage.

    pattern:
      code: |
        # 1. Quick backup command
        sudo vps-backup-simple

        # 2. What gets backed up:
        # - /etc/xray - VPN configurations
        # - /usr/local/x-ui - X-ui panel data
        # - /etc/nginx - Web server configs
        # - /home/ozand/.claude - AI tools and scripts
        # - /home/ozand/filebrowser - File browser data

        # 3. Backup destination (via Tailscale):
        # ozand@100.82.9.44:/home/ozand/backups/vps/

      explanation: |
        Uses rsync over Tailscale VPN to transfer backups to home server.
        Efficient incremental transfers only copy changed files.

    automation:
      code: |
        # Cron job for daily backups (already configured):
        # /etc/cron.d/vps-backup
        0 2 * * * root /usr/local/bin/vps-backup-simple >/var/log/vps-backup.log 2>&1

        # Check backup logs:
        tail -f /var/log/vps-backup.log

    restore:
      code: |
        # Restore from backup
        sudo vps-restore

        # Manual restore from backup:
        # 1. List available backups
        ssh ozand@100.82.9.44 "ls -lh /home/ozand/backups/vps/"

        # 2. Copy specific backup
        rsync -avz ozand@100.82.9.44:/home/ozand/backups/vps/etc/xray/ /etc/xray/

        # 3. Restore service
        systemctl restart x-ui.service

    verification:
      code: |
        # Check if backup ran successfully
        sudo tail -20 /var/log/vps-backup.log

        # Verify backup exists on remote server
        ssh ozand@100.82.9.44 "ls -lh /home/ozand/backups/vps/ | tail -5"

        # Check backup size
        ssh ozand@100.82.9.44 "du -sh /home/ozand/backups/vps/"

    best_practices:
      - "Run backups daily during low-traffic hours (2 AM)"
      - "Keep at least 7 days of backups"
      - "Test restore procedure monthly"
      - "Monitor backup logs for errors"
      - "Include backups in disaster recovery plan"

    troubleshooting:
      code: |
        # If SSH password is required:
        # 1. Setup SSH keys
        ssh-keygen -t ed25519
        ssh-copy-id ozand@100.82.9.44

        # 2. Test connection
        ssh ozand@100.82.9.44 "hostname"

        # If rsync fails:
        # - Check Tailscale connection: tailscale status
        # - Verify remote server is accessible: ping 100.82.9.44
        # - Check disk space on remote: ssh ozand@100.82.9.44 "df -h"

    related_issues:
      - "VPS-BP-005: 3-2-1 backup strategy"
      - "VPS-MEM-003: Resource optimization for backup jobs"

    references:
      - "vps-backup-simple.sh script"
      - "vps-restore.sh script"
